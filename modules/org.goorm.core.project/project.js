var fs=require("fs"),walk=require("walk"),rimraf=require("rimraf"),EventEmitter=require("events").EventEmitter,exec=require("child_process").exec,projects=[];module.exports={do_new:function(e,t){var n={};n.err_code=0,n.message="process done",e.project_type!=null&&e.project_detailed_type!=null&&e.project_author!=null&&e.project_name!=null&&e.project_about!=null&&e.use_collaboration?fs.readdir(__path+"workspace/",function(r,i){if(r!=null)n.err_code=10,n.message="Server can not response",t.emit("project_do_new",n);else{var s=e.project_author+"_"+e.project_name;i.hasObject(s)?(n.err_code=20,n.message="Exist project",t.emit("project_do_new",n)):fs.mkdir(__path+"/workspace/"+s,"0777",function(r){if(r!=null)n.err_code=30,n.message="Cannot make directory",t.emit("project_do_new",n);else{var i=new Date,o=i.getFullYear()+"/"+i.getMonth()+"/"+i.getDate()+" "+i.getHours()+":"+i.getMinutes()+":"+i.getSeconds(),u='{"type": "'+e.project_type+'", "detailedtype": "'+e.project_detailed_type+'", "author": "'+e.project_author+'", "name": "'+e.project_name+'", "about": "'+e.project_about+'", "date": "'+o+'", "collaboration": "'+e.use_collaboration+'"}';fs.writeFile(__path+"workspace/"+s+"/project.json",u,function(r){r!=null?(n.err_code=40,n.message="Can not make project file",t.emit("project_do_new",n)):(n.project_name=e.project_name,n.project_author=e.project_author,n.project_type=e.project_type,t.emit("project_do_new",n))})}})}}):(n.err_code=10,n.message="Invalid query",t.emit("project_do_new",n))},do_delete:function(e,t){var n={};n.err_code=0,n.message="process done",e.project_path!=null?rimraf(__path+"workspace/"+e.project_path,function(e){e!=null?(n.err_code=20,n.message="Can not delete project",t.emit("project_do_delete",n)):t.emit("project_do_delete",n)}):(n.err_code=10,n.message="Invalide query",t.emit("project_do_delete",n))},do_import:function(e,t,n){var r={};r.err_code=0,r.message="process done";if(e.project_import_location!=null&&t!=null)var i=exec("unzip -o "+t.path+" -d workspace/"+e.project_import_location,function(e,i,s){e==null?(rimraf(t.path,function(e){e!=null}),n.emit("project_do_import",r)):(r.err_code=20,r.message="Cannot extract zip file",n.emit("project_do_import",r))});else r.err_code=10,r.message="Invalide query",n.emit("project_do_import",r)},do_export:function(e,t){var n={};n.err_code=0,n.message="process done",e.user!=null&&e.project_path!=null&&e.project_name!=null?fs.mkdir(__path+"temp_files/"+e.user,"0777",function(r){if(r==null||r.errno==47)var i=exec("cd workspace; zip -r ../temp_files/"+e.user+"/"+e.project_name+".zip ./"+e.project_path,function(r,i,s){r==null?(n.path=e.user+"/"+e.project_name+".zip",t.emit("project_do_export",n)):(n.err_code=20,n.message="Cannot make zip file",t.emit("project_do_export",n))});else n.err_code=30,n.message="Cannot make directory",t.emit("project_do_export",n)}):(n.err_code=10,n.message="Invalide query",t.emit("project_do_export",n))},get_list:function(e){var t=this;projects=[];var n={followLinks:!1},r=walk.walk(__path+"workspace",n);r.on("directories",function(n,r,i){var s=r.length;if(n==__path+"workspace"){var o=0,u=new EventEmitter;u.on("get_list",function(){o++,o<r.length?t.get_project_info(r[o],u):e.emit("project_get_list",projects)}),t.get_project_info(r[o],u)}i()}),r.on("end",function(){})},get_project_info:function(e,t){var n={};n.name=e.name,fs.readFile(__path+"workspace/"+n.name+"/project.json","utf-8",function(e,r){e==null&&(n.contents=JSON.parse(r),projects.push(n)),t.emit("get_list")})},get_property:function(e,t){var n={};n.err_code=0,n.message="process done",e.project_path!=null?fs.readFile(__path+"workspace/"+e.project_path+"/project.json","utf-8",function(e,r){e==null?(n.contents=JSON.parse(r),t.emit("get_property",n)):(n.err_code=20,n.message="Can not read project file.",t.emit("get_property",n))}):(n.err_code=10,n.message="Invalid query",t.emit("get_property",n))},do_clean:function(e,t){var n=this,r={};r.err_code=0,r.message="process done",console.log(e.project_list);if(e.project_list!=null){var i=e.project_list.length,s=0,o=new EventEmitter;console.log(i+" "+s),o.on("do_delete_for_clean",function(){s++,s<i?n.do_delete_for_clean(e.project_list[s],o):t.emit("project_do_clean",r)}),n.do_delete_for_clean(e.project_list[s],o)}else r.err_code=10,r.message="Invalide query",t.emit("project_do_clean",r)},do_delete_for_clean:function(e,t){console.log(e+"pre"),rimraf(__path+"workspace/"+e+"/build",function(n){console.log(e+"post"),t.emit("do_delete_for_clean")})}};