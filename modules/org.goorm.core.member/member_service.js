//이메일 정규식
var reg_email=/^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i,reg_id_pw=/^[a-z0-9_]{4,20}$/,g_member_dao=require("./member_dao");module.exports={login:function(e,t){if(e.body.auth_type=="password"){if(e.body.id==""||e.body.pw==""){t({err:{code:3,message:"아이디 또는 패스워드가 입력되지 않았습니다."}});return}g_member_dao.get(e.body.id,function(n){n&&!n.deleted?e.body.pw==n.pw?(n.auth_type="password",n.loggedin=!0,delete n.pw,delete n.deleted,e.session.user=n,console.log("req.session.user : ",n),t({err:!1,info:n})):t({err:{code:1,message:"패스워드가 일치하지 않습니다."}}):t({err:{code:2,message:"존재하지 않는 회원입니다."}})})}else e.user?g_member_dao.get(e.body.auth_type+e.user[e.body.auth_type].id,function(n){if(n&&!n.deleted){n.auth_type=e.body.auth_type,n=create_login_status(n);switch(n.auth_type){case"facebook":break;case"twitter":n.id="twitter"+e.user.twitter.id,n.name=e.user.twitter.name,n.nick=e.user.twitter.screen_name;break;case"google":n.id="google"+e.user.google.id,n.nick=n.name=e.user.google.name}e.session.user=n,console.log("req.session.user : ",n),t({err:!1,info:n})}else t({err:{code:2,message:"존재하지 않는 회원입니다."}})}):t({err:{code:4,message:"소셜로그인이 이루어지지 않았습니다."}})},logout:function(e,t){e.session.destroy(),e.loggedIn&&e.logout(),t({err:!1,message:"성공적으로 로그아웃 되었습니다."})},get_login_status:function(e,t){if(e.session.user)t(e.session.user);else{var n="password";e.user&&(console.log("req.user:",e.user),e.user.twitter&&(n="twitter"),e.user.facebook&&(n="facebook"),e.user.google&&(n="google"));switch(n){case"password":t({loggedin:!1,auth_type:"password"});break;case"facebook":t({loggedin:!1,auth_type:"facebook",id:e.user.facebook.id});break;case"twitter":t({loggedin:!1,auth_type:"twitter",id:e.user.twitter.id,nick:e.user.twitter.screen_name,name:e.user.twitter.name,picture:e.user.twitter.profile_image_url});break;case"google":t({loggedin:!1,auth_type:"google",id:e.user.google.id,nick:e.user.google.name,name:e.user.google.name})}}},everyauth_init:function(e,t){function i(e,t){var i;return arguments.length===1?(i=t=e,i.id=++r,console.log(n),n[r]=i):(i=n[++r]={id:r},i[e]=t,console.log(n),i)}var n={},r=0,s={},o={},u={};e.everymodule.findUserById(function(e,t){t(null,n[e])}),e.facebook.myHostname("http://localhost:3000").appId(t.fb.appId).appSecret(t.fb.appSecret).findOrCreateUser(function(e,t,n,r){return s[r.id]||(s[r.id]=i("facebook",r))}).redirectPath("/cms/member/social_login/facebook"),e.twitter.consumerKey(t.twit.consumerKey).consumerSecret(t.twit.consumerSecret).findOrCreateUser(function(e,t,n,r){return o[r.id]||(o[r.id]=i("twitter",r))}).redirectPath("/cms/member/social_login/twitter"),e.google.appId(t.google.clientId).appSecret(t.google.clientSecret).scope("https://www.googleapis.com/auth/userinfo.profile https://www.google.com/m8/feeds/").findOrCreateUser(function(e,t,n,r){return r.refreshToken=n.refresh_token,r.expiresIn=n.expires_in,u[r.id]||(u[r.id]=i("google",r))}).redirectPath("/cms/member/social_login/google")}};