/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.plugin.nodejs=function(){this.name="nodejs",this.mainmenu=null,this.build_options=null,this.build_source=null,this.build_target=null,this.build_file_type="o",this.debug_con=null,this.current_debug_project=null,this.terminal=null,this.breakpoints=null},org.goorm.plugin.nodejs.prototype={init:function(){this.addProjectItem(),this.mainmenu=core.module.layout.mainmenu,this.cErrorFilter=/[A-Za-z]* error: [A-Za-z0-9 '",:_\\\/\.\+\-\*\#\@]*/,this.cWarningFilter=/[A-Za-z]* warning: [A-Za-z0-9 '",:_\\\/\.\+\-\*\#\@]*/,this.lineFilter=/:[0-9]*:/,this.add_mainmenu()},addProjectItem:function(){$("div[id='project_new']").find(".project_types").append("<div class='project_wizard_first_button' project-type='nodejsp'><div class='project_type_icon'><img src='/org.goorm.plugin.nodejs/images/nodejs.png' class='project_icon' /></div><div class='project_type_title'>nodejs Project</div><div class='project_type_description'>nodejs Project using GNU Compiler Collection</div></div>"),$("div[id='project_new']").find(".project_items").append("<div class='project_wizard_second_button all nodejsp' description='  Create New Project for nodejs' projecttype='nodejs'><img src='/org.goorm.plugin.nodejs/images/nodejs_console.png' class='project_item_icon' /><br /><a>nodejs Project</a></div>"),$(".project_dialog_type").append("<option value='c'>nodejs Projects</option>")},add_mainmenu:function(){var e=this;$("ul[id='plugin_new_project']").append('<li class="yuimenuitem"><a class="yuimenuitemlabel" href="#" action="new_file_nodejs" localizationKey=\'file_new_nodejs_project\'>nodejs Project</a></li>'),this.mainmenu.render()},add_menu_action:function(){$("a[action=new_file_nodejs]").unbind("click"),$("a[action=new_file_nodejs]").click(function(){core.dialog.new_project.show(),$(".project_wizard_first_button[project-type=nodejs]").trigger("click"),$("#project_new").find(".project_types").scrollTop($(".project_wizard_first_button[project-type=nodejs]").position().top-100)})},new_project:function(e){var t={plugin:"org.goorm.plugin.nodejs",data:e};$.get("/plugin/new",t,function(e){core.module.layout.project_explorer.refresh()})},run:function(e){var t=this,n="",r="main.js",i="node "+n+" "+r;console.log(i),core.module.layout.terminal.send_command(i+"\r")},debug:function(e){var t=this,n=core.module.debug.table_variable,r=core.module.debug;this.terminal=core.module.layout.workspace.window_manager.open("/","debug","terminal","Terminal").terminal,this.current_debug_project=e,n.initializeTable(),n.refreshView(),this.breakpoints=[];var i={plugin:"org.goorm.plugin.nodejs",path:e,mode:"init"};this.terminal.index!=-1?t.debug_cmd(i):$(this.terminal).one("terminal_ready",function(){t.debug_cmd(i)}),this.debug_port=null,this.status_updated=!1;var s=null,o=[],u={started:!1,terminated:!1,connected:!1,prompt:!1};$(core.module.debug).off("terminal_msg"),$(core.module.debug).on("terminal_msg",function(r,i){var a=/backtrace/,f=/debug>/;/program terminated/.test(i)?u.terminated=!0:/connecting[\. ]*ok/.test(i)?u.connected=!0:f.test(i)&&(u.prompt=!0);if(u.terminated){n.initializeTable(),n.refreshView();while(o.length>0)clearTimeout(o.pop());$.get("/remove_port",{port:t.debug_port});var l=core.module.layout.workspace.window_manager.window;for(var c in l){var h=l[c];h.editor&&h.editor.clear_highlight()}u.terminated=!1}else!u.started&&u.connected&&u.prompt?(console.log("nodejs","ready"),t.debug_cmd({mode:"run",project_path:e}),u.started=!0,u.connected=!1,u.prompt=!1):u.started&&t.status_updated===!1&&u.prompt&&(t.terminal.send_command("backtrace\r"),t.status_updated=!0,u.prompt=!1);if(f.test(i)){if(s!=null){var p=s.split("\n"),d=null;$.each(p,function(e,n){if(n=="")return;if(a.test(n))console.log("@catch","where"),d=1;else if(d==1){var r=/#0 (.*):([\d]+):([\d]+)/;if(r.test(n)){var i=n.match(r);console.log(i);var s=i[1],o=i[2],u=core.module.layout.workspace.window_manager.window;for(var f=0;f<u.length;f++){var l=u[f];l.project==t.current_debug_project&&l.filename==s&&l.editor.highlight_line(o)}}}}),n.refreshView()}s=i}else s+="\n"+i}),$(r).off("value_changed"),$(r).on("value_changed",function(e,n){t.terminal.send_command("set "+n.variable+"="+n.value+"\r")})},debug_cmd:function(e){var t=this;if(this.terminal===null){console.log("no connection!");return}this.status_updated=!1;if(e.mode=="init")$.getJSON("/alloc_port",{process_name:"node debug"},function(e){t.debug_port=e.port,t.terminal.send_command("node debug --port="+e.port+" main.js\r")});else{var n=core.module.layout.workspace.window_manager.window;for(var r=0;r<n.length;r++){var i=n[r],s=[];if(i.project==this.current_debug_project){var o=i.filename;if(i.editor===null)continue;var u=i.editor.breakpoints;for(var a=0;a<t.breakpoints.length;a++)s.push(t.breakpoints[a]);if(u.length>0)for(var a=0;a<u.length;a++){var f=u[a];f+=1,f="'"+o+"', "+f;var l=s.inArray(f);l==-1?(console.log("nodejs","setBreakpoint("+f+")"),t.terminal.send_command("setBreakpoint("+f+")\r"),t.breakpoints.push(f)):s.remove(l)}for(var a=0;a<s.length;a++){var l=t.breakpoints.inArray(s[a]);l!=-1&&(t.breakpoints.remove(l),t.terminal.send_command("clearBreakpoint("+s[a]+")\r"))}}}switch(e.mode){case"run":break;case"continue":t.terminal.send_command("cont\r");break;case"terminate":t.terminal.send_command("quit\r"),table_variable.initializeTable(),table_variable.refreshView(),t.status_updated=!0,$.get("/remove_port",{port:t.debug_port});break;case"step_over":t.terminal.send_command("next\r");break;case"step_in":t.terminal.send_command("step\r");break;case"step_out":t.terminal.send_command("out\r");break;default:}}},build:function(e,t,n){var r=this;console.log("build not needed for nodejs."),n&&n()},clean:function(){console.log("nodejs clean")}};