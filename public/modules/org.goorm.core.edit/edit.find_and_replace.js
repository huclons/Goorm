/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.edit.find_and_replace=function(){this.dialog=null,this.buttons=null,this.editor=null,this.last_pos=null,this.last_query=null,this.marked=[],this.match_case=!1,this.ignore_whitespace=!1,this.use_regexp=!1,this.replace_cursor=null},org.goorm.core.edit.find_and_replace.prototype={init:function(){var e=this;this.buttons=[{text:"Find",handler:function(){e.find()}},{text:"Find All",handler:function(){e.find_all()}},{text:"Replace/Find",handler:function(){e.handle_replace_and_find()}},{text:"Replace",handler:function(){e.handle_replace()}},{text:"Replace All",handler:function(){e.handle_replace_all()}},{text:"Close",handler:function(){e.hide()}}],this.dialog=new org.goorm.core.edit.find_and_replace.dialog,this.dialog.init({title:"Find/Replace",path:"configs/dialogs/org.goorm.core.edit/edit.find_and_replace.html",width:550,height:300,modal:!1,buttons:this.buttons,draggable:!0,success:function(){$("#find_query_inputbox").keydown(function(t){var n=t||event;if(n.keyCode==13)return e.find(),t.stopPropagation(),t.preventDefault(),!1}),e.dialog.panel.hideEvent.subscribe(function(t){e.unmark()}),$("#match_case").change(function(){$("#match_case")[0].checked==1?e.match_case=!0:e.match_case=!1}),$("#match_case_checkbox_name").click(function(){$("#match_case")[0].checked==1?($("#match_case")[0].checked=!1,e.match_case=!1):($("#match_case")[0].checked=!0,e.match_case=!0)}),$("#ignore_whitespace").change(function(){$("#ignore_whitespace")[0].checked==1?e.ignore_whitespace=!0:e.ignore_whitespace=!1}),$("#ignore_whitespace_checkbox_name").click(function(){$("#ignore_whitespace")[0].checked==1?($("#ignore_whitespace")[0].checked=!1,e.ignore_whitespace=!1):($("#ignore_whitespace")[0].checked=!0,e.ignore_whitespace=!0)}),$("#use_regexp").change(function(t){$("#use_regexp")[0].checked==1?(e.use_regexp=!0,$("#match_case")[0].disabled=!0,$("#ignore_whitespace")[0].disabled=!0):(e.use_regexp=!1,$("#match_case")[0].disabled=!1,$("#ignore_whitespace")[0].disabled=!1)}),$("#use_regexp_checkbox_name").click(function(){$("#use_regexp")[0].checked==1?($("#use_regexp")[0].checked=!1,e.use_regexp=!1,$("#match_case")[0].disabled=!1,$("#ignore_whitespace")[0].disabled=!1):($("#use_regexp")[0].checked=!0,e.use_regexp=!0,$("#match_case")[0].disabled=!0,$("#ignore_whitespace")[0].disabled=!0)})}}),this.dialog=this.dialog.dialog},find:function(e){var t=core.module.layout.workspace.window_manager;if(t.window[t.active_window].editor){var n=t.window[t.active_window].editor.editor,r=$("#find_query_inputbox").val();this.search(r,n,e)}},find_all:function(){var e=core.module.layout.workspace.window_manager;if(e.window[e.active_window].editor){var t=e.window[e.active_window].editor.editor,n=$("#find_query_inputbox").val();this.search_all(n,t)}},handle_replace_and_find:function(){var e=core.module.layout.workspace.window_manager;if(e.window[e.active_window].editor){var t=e.window[e.active_window].editor.editor,n=$("#find_query_inputbox").val(),r=$("#replace_query_inputbox").val();this.replace(n,r,t),this.search(n,t)}},handle_replace:function(){var e=core.module.layout.workspace.window_manager;if(e.window[e.active_window].editor){var t=e.window[e.active_window].editor.editor,n=$("#find_query_inputbox").val(),r=$("#replace_query_inputbox").val();this.replace(n,r,t)}},handle_replace_all:function(){var e=core.module.layout.workspace.window_manager;if(e.window[e.active_window].editor){var t=e.window[e.active_window].editor.editor,n=$("#find_query_inputbox").val(),r=$("#replace_query_inputbox").val();this.replace_all(n,r,t)}},search:function(e,t,n){if(!e)return;var r=e,i=!0;this.use_regexp==1?r=RegExp(e,"g"):(this.match_case==1&&(i=!1),this.ignore_whitespace==1&&(r=r.replace(/\s*/g,""))),this.unmark();for(var s=t.getSearchCursor(r,null,i);s.findNext();)this.marked.push(t.markText(s.from(),s.to(),"searched"));this.last_query!=r&&(this.last_pos=null);var s=t.getSearchCursor(r,this.last_pos?this.last_pos:t.getCursor(),i);if(n=="previous"){s.find_previous();if(s.find_previous()==0){for(s=t.getSearchCursor(r,null,i);s.findNext(););s.find_previous();if(!t.getSearchCursor(r,null,i).findNext())return}}else if(!s.findNext()){s=t.getSearchCursor(r,null,i);if(!s.findNext())return}t.setSelection(s.from(),s.to()),this.replace_cursor=s,this.last_query=r,this.last_pos=s.to()},search_all:function(e,t){if(!e)return;var n=e,r=!0;this.use_regexp==1?n=RegExp(e,"g"):(this.match_case==1&&(r=!1),this.ignore_whitespace==1&&(n=n.replace(/\s*/g,""))),core.module.layout.inner_bottom_tabview.selectTab(3),core.module.search.clean();var i=[];this.unmark();for(var s=t.getSearchCursor(n,null,r);s.findNext();){this.marked.push(t.markText(s.from(),s.to(),"searched"));var o={fline:s.from().line,fch:s.from().ch,tline:s.to().line,tch:s.to().ch};i.push(o)}for(var u=i.length-1;u>-1;u--)core.module.search.m(i[u].fline,i[u].fch,i[u].tline,i[u].tch,t.getLine(i[u].fline));this.dialog.panel.hide(),$(".search_message").click(function(){$(".search_message").css("background-color",""),$(this).css("background-color","#fff8dc");var e=parseInt($(this).attr("fline")),n=parseInt($(this).attr("fch")),r=parseInt($(this).attr("tline")),i=parseInt($(this).attr("tch")),s={line:e,ch:n},o={line:r,ch:i};t.setSelection(s,o)})},replace_search:function(e,t,n){if(!e)return;var r=e,i=t,s=!0;this.use_regexp==1?r=RegExp(e,"g"):(this.match_case==1&&(s=!1),this.ignore_whitespace==1&&(r=r.replace(/\s*/g,""))),this.unmark();for(var o=n.getSearchCursor(r,null,s);o.findNext();)this.marked.push(n.markText(o.from(),o.to(),"searched"));this.last_query!=r&&(this.last_pos=null);var o=n.getSearchCursor(r,n.getCursor()||this.last_pos,s);if(!o.findNext()){o=n.getSearchCursor(r,null,s);if(!o.findNext())return}n.setSelection(o.from(),o.to()),this.last_query=r,this.last_pos=o.to()},replace:function(e,t,n){if(!e)return;var r=e,i=t,s=!0;this.use_regexp==1?r=RegExp(e,"g"):(this.match_case==1&&(s=!1),this.ignore_whitespace==1&&(r=r.replace(/\s*/g,""))),this.unmark();var o=n.getSearchCursor(r,this.last_pos,s);o.find_previous(),n.replaceRange(i,o.from(),o.to())},replace_all:function(e,t,n){if(!e)return;var r=e,i=t,s=!0;this.use_regexp==1?r=RegExp(e,"g"):(this.match_case==1&&(s=!1),this.ignore_whitespace==1&&(r=r.replace(/\s*/g,""))),core.module.layout.inner_bottom_tabview.selectTab(3),core.module.search.clean(),this.unmark();for(var o=n.getSearchCursor(r,null,s);o.findNext();)n.replaceRange(i,o.from(),o.to()),core.module.search.mreplace_all(o.from().line,o.from().ch,o.to().line,o.to().ch,r,i);this.dialog.panel.hide(),$(".search_message").click(function(){$(".search_message").css("background-color",""),$(this).css("background-color","#fff8dc");var e=parseInt($(this).attr("fline")),t=parseInt($(this).attr("fch")),r=parseInt($(this).attr("tline")),s=parseInt($(this).attr("tch")),o={line:e,ch:t},u={line:r,ch:t+i.length};n.setSelection(o,u)})},unmark:function(){for(var e=0;e<this.marked.length;++e)this.marked[e].clear();this.marked.length=0},show:function(){this.dialog.panel.show();var e=core.module.layout.workspace.window_manager;if(e.window[e.active_window].editor){var t=e.window[e.active_window].editor.editor;$("#find_query_inputbox").val(t.getSelection())}$("#find_query_inputbox").select()},hide:function(){this.dialog.panel.hide()}};