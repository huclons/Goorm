/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.edit=function(){this.target=null,this.editor=null,this.find_and_replace=null,this.filepath=null,this.filename=null,this.filetype=null,this.string_props=null,this.array_props=null,this.func_props=null,this.keywords=null,this.collaboration=null,this.theme="elegant",this.mode="htmlmixed",this.indent_unit=2,this.indent_with_tabs=!0,this.tab_mode="classic",this.enter_mode="indent",this.show_line_numbers=!0,this.first_line_number=1,this.undo_depth=40,this.highlight_current_cursor_line=!0,this.highlighted_line=null,this.preference=null,this.context_menu=null,this.timestamp=null,this.fromCh=null,this.toCh=null,this.breakpoints=[]},org.goorm.core.edit.prototype={init:function(e,t){var n=this;this.target=e,this.title=t;var r=!1,i=!1;this.collaboration=new org.goorm.core.collaboration.editing,this.preference=core.preference,this.dictionary=new org.goorm.core.edit.dictionary,this.timestamp=(new Date).getTime(),$(e).append("<textarea class='code_editor'>Loading Data...</textarea>");var s=CodeMirror.newFoldFunction(CodeMirror.braceRangeFinder);this.object_tree=new YAHOO.widget.TreeView("object_tree"),this.editor=CodeMirror.fromTextArea($(e).find(".code_editor")[0],{lineNumbers:!0,lineWrapping:!0,wordWrap:!0,matchBrackets:!0,extraKeys:{"Ctrl-Q":function(e){s(e,e.getCursor().line)},"'>'":function(e){e.closeTag(e,">")},"'/'":function(e){e.closeTag(e,"/")},"Ctrl-Space":function(e){var t=e.getCursor(),r=e.getTokenAt(t),i=e.charCoords({line:t.line,ch:r.start},"local");n.dictionary.search(r.string),n.dictionary.show(i)}},onKeyEvent:function(e,t){if($(n.target).find(".dictionary_box").css("display")=="block"&&t.type=="keyup"&&t.keyCode!=8&&t.keyCode!=32){console.log(t.keyCode);var r=n.editor.getCursor(),s=n.editor.getTokenAt(r),o=n.editor.charCoords({line:r.line,ch:s.start},"local");n.dictionary.search(s.string),n.dictionary.show(o)}if(t.type=="keydown"&&t.keyIdentifier=="Enter")return i=!0,n.toCh=n.editor.getCursor(!1),n.fromCh=n.editor.getCursor(!0),!1;if(t.ctrlKey||t.metaKey||t.altKey)if(t.keyCode!=67&&t.keyCode!=86&&t.keyCode!=88){var u=$.Event("keydown");return u.which=t.which,u.keyCode=t.keyCode,u.ctrlKey=t.ctrlKey,u.metaKey=t.metaKey,u.altKey=t.altKey,u.shiftKey=t.shiftKey,$(document).trigger(u),t.stopPropagation(),t.preventDefault(),!1}},onChange:function(e,t){if(r){if(n.collaboration.updating_process_running==0){var s=t;if(i==1){var o=n.editor.getLine(s.to.line);s.text[0]="\n",s.from.line=n.fromCh.line,s.to.line=n.toCh.line,s.from.ch=n.fromCh.ch,s.to.ch=n.toCh.ch,n.collaboration.update_change(s),s.text[0]=o,s.from.line=s.to.line+1,s.to.line=s.to.line+1,n.fromCh.line!=n.toCh.line&&(s.from.line=n.editor.getCursor().line,s.to.line=n.editor.getCursor().line),s.to.ch=99999,s.from.ch=0,i=!1}else n.collaboration.update_change(s)}}else r=!0;var u=core.module.layout.workspace.window_manager;u.window[u.active_window].set_modified(),u.tab[u.active_window].set_modified()},onCursorActivity:function(){$(n.target).find(".CodeMirror-gutter-text pre").removeClass("current_line"),$(n.target).find(".CodeMirror-gutter-text pre:nth-child("+(n.editor.getCursor().line+1)+")").addClass("current_line"),$(n.target).parent().parent().find(".ft").find(".editor_message").html("Line: "+(parseInt(n.editor.getCursor().line)+1)+" | Col: "+n.editor.getCursor().ch),n.collaboration.update_cursor({line:n.editor.getCursor().line,ch:n.editor.getCursor().ch}),n.editor.matchHighlight("CodeMirror-matchhighlight")},onFocus:function(){core.status.focus_on_editor=!0,n.filetype!="js"&&(delete n.object_tree,$("#object_tree").empty())},onBlur:function(){core.status.focus_on_editor=!1},onGutterClick:function(e,t){var r=e.lineInfo(t);if($(n.target).find(".CodeMirror-gutter-text pre:eq("+t+")").find(".breakpoint").length>0){$(n.target).find(".CodeMirror-gutter-text pre:eq("+t+")").find(".breakpoint").remove(),n.breakpoints=n.breakpoints.unique();var i=n.breakpoints.inArray(t);n.breakpoints.remove(i,i)}else $(n.target).find(".CodeMirror-gutter-text pre:eq("+t+")").prepend("<span class='breakpoint'>‚óè</span>"),n.breakpoints=n.breakpoints.unique(),n.breakpoints.push(t);s(e,t)},onUpdate:function(){n.set_foldable()}}),this.set_dictionary(),this.collaboration.init(this),this.collaboration.set_editor(this.editor),this.set_option(),$(e).keypress(function(e){return e.which!=115||!e.ctrlKey?!0:(n.save(),e.preventDefault(),!1)}),$(document).bind("on_preference_confirmed",function(){n.set_option()}),$(this.target).click(function(){n.dictionary.hide()}),this.context_menu=new org.goorm.core.menu.context,this.context_menu.init("configs/menu/org.goorm.core.edit/edit.context.html","edit.context",this.target,this.timestamp,null,function(){core.module.action.init()}),$(this.target).find(".CodeMirror-lines div:first").append("<div class='highlight_line'></div>")},highlight_line:function(e){var t=this.editor.charCoords({line:e-1,ch:0},"local");console.log(t),$(this.target).find(".highlight_line").css("top",t.y),$(this.target).find(".highlight_line").show()},clear_highlight:function(){$(this.target).find(".highlight_line").hide()},set_foldable:function(){var e=this;this.editor&&($(this.target).find(".CodeMirror-gutter-text").find("pre").find(".folding_icon_minus").remove(),$(this.target).find(".CodeMirror-gutter-text").find("pre").each(function(t){e.editor.getLine(t).indexOf("{")>-1&&$(this).prepend("<div class='folding_icon_minus'></div>")}))},resize_all:function(){},analyze:function(){var e=this;delete e.object_tree,e.object_tree=new YAHOO.widget.TreeView("object_tree");var t=e.object_tree.getRoot(),n=[],r=1,i=!0,s=e.editor.lineCount(),o=e.editor.posFromIndex(r),u=e.editor.getTokenAt(o),a=0,f=0,l=t,c=t,h=[];while(i){if(u.string.replace(/ /g,"").replace(/\t/g,"").replace(/\n/g,"")!=""&&u.className!="comment"){u.className==null&&(u.string=="="||u.string==":")&&(u.className="assignment"),u.string.indexOf("{")>-1?(u.className="block_start",c=l,l=h[h.length-1],f++):u.string.indexOf("}")>-1&&(u.className="block_end",l=c,f--),u.string.indexOf("(")>-1?u.className="bracket_start":u.string.indexOf(")")>-1&&(u.className="bracket_end"),u.className==null&&u.string=="["?u.className="square_bracket_start":u.className==null&&u.string=="]"&&(u.className="square_bracket_end"),u.className==null&&u.string==","&&(u.className="comma"),u.className==null&&(u.string=="+"||u.string=="-"||u.string=="/"||u.string=="*"||u.string=="%"||u.string=="."||u.string=="++"||u.string=="--")&&(u.className="operator"),u.className==null&&(u.string=="=="||u.string=="!="||u.string=="!"||u.string=="==="||u.string=="&&"||u.string=="||")&&(u.className="logical_operator"),u.className==null&&u.string==";"&&(u.className="semicolon");if(u.className=="variable"||u.className=="variable-2"||u.className=="block_start"){var p=u.string;u.className=="block_start"&&(p="<span class='block_start'></span>"),h.push(new YAHOO.widget.HTMLNode(p,l,!0)),h[h.length-1].type=u.className}u.className=="property"&&(h[h.length-1].html+="."+u.string),u.className=="assignment"&&(h[h.length-1].html+=" : "),u.className=="bracket_start"&&(h[h.length-1].html+="<span style='color:red;'> <- </span>"),u.className=="keyword"&&(h[h.length-1].html+="<span style='color:purple;'>"+u.string+"</span>"),u.className=="string"&&(h[h.length-1].html+="<span style='color:gray;'>"+u.string+"</span>"),u.className=="atom"&&(h[h.length-1].html+="<span style='color:blue;'>"+u.string+"</span>"),u.className=="def"&&(h[h.length-1].html+=" <span style='color:darkgray;'>"+u.string+"</span>")}r+=u.end-u.start,u.end-u.start==0&&r++,o=e.editor.posFromIndex(r),u=e.editor.getTokenAt(o),o.line==s-1&&o.ch==u.end&&(i=!1)}e.object_tree.render()},set_option:function(){this.indent_unit=parseInt(this.preference["preference.editor.indent_unit"]),this.indent_with_tabs=this.preference["preference.editor.indent_with_tabs"],this.tab_mode=this.preference["preference.editor.tab_mode"],this.enter_mode=this.preference["preference.editor.enter_mode"],this.show_line_numbers=this.preference["preference.editor.show_line_numbers"],this.first_line_number=parseInt(this.preference["preference.editor.first_line_number"]),this.undo_depth=parseInt(this.preference["preference.editor.undo_depth"]),this.highlight_current_cursor_line=this.preference["preference.editor.highlight_current_cursor_line"],this.theme=this.preference["preference.editor.theme"],this.indent_unit!=undefined&&this.editor.setOption("indentUnit",this.indent_unit),this.indent_with_tabs!=undefined&&this.editor.setOption("indentWithTabs",this.indent_with_tabs),this.tab_mode!=undefined&&this.editor.setOption("tabMode",this.tab_mode),this.enter_mode!=undefined&&this.editor.setOption("enterMode",this.enter_mode),this.show_line_numbers!=undefined&&this.editor.setOption("showLineNumbers",this.show_line_numbers);if(this.first_line_number!=undefined||this.first_line_number!=NaN)console.log(this.preference["preference.editor.first_line_number"]),this.editor.setOption("firstLineNumber",this.first_line_number);(this.undo_depth!=undefined||this.undo_depth!=NaN)&&this.editor.setOption("undoDepth",this.undo_depth),this.theme!=undefined&&this.editor.setOption("theme",this.theme)},load:function(e,t,n){var r=this,i="file/get_contents";n=="url"&&(t="",i="file/get_url_contents");var s=e+"/"+t;this.filepath=e,this.filename=t,this.filetype=n;var o=0;this.interval=window.setInterval(function(){o<100?statusbar.progressbar.set("value",o+=10):window.clearInterval(r.interval)},100),statusbar.start();var u="";n=="url"?u=e:u="workspace/"+e+"/"+t;var a={path:u};$.get(i,a,function(e){r.editor.setValue(e),r.collaboration.set_filepath(),statusbar.progressbar.set("value",100),r.interval&&window.clearInterval(r.interval),r.editor.clearHistory(),r.set_foldable(),r.dictionary.init(r.target,r.editor,r.filetype),statusbar.stop();var t=core.module.layout.workspace.window_manager;t.window[t.active_window].set_saved(),t.tab[t.active_window].set_saved()})},save:function(e){var t=this,n="file/put_contents",r=this.filepath+"/"+this.filename,i=this.editor.getValue(),s={path:r,data:i};$.get(n,s,function(n){core.flag.collaboration_on==1&&t.collaboration.socket.send('{"channel": "edit","action":"autoSaved", "identifier":"'+t.collaboration.identifier+'", "message":""}');var r=new Date,i=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds();m.s("Save Complete! ("+i+")","editor");var s=core.module.layout.workspace.window_manager;s.window[s.active_window].set_saved(),s.tab[s.active_window].set_saved(),e=="close"&&s.window[s.active_window].close()})},get_contents:function(){var e=this;return e.editor.getValue()},set_dictionary:function(){this.string_props="charAt charCodeAt indexOf lastIndexOf substring substr slice trim trimLeft trimRight toUpperCase toLowerCase split concat match replace search".split(" "),this.array_props="length concat join splice push pop shift unshift slice reverse sort indexOf lastIndexOf every some filter for_each map reduce reduceRight ".split(" "),this.func_props="prototype apply call bind".split(" "),this.keywords="break case catch continue debugger default delete do else false finally for function if in instanceof new null return switch throw true try typeof var void while with".split(" ")},stop_event:function(){this.preventDefault?(this.preventDefault(),this.stopPropagation()):(this.return_value=!1,this.cancel_bubble=!0)},add_stop:function(e){return e.stop||(e.stop=this.stop_event),e},for_each:function(e,t){for(var n=0,r=e.length;n<r;++n)t(e[n])},set_mode:function(e){this.editor.setOption("mode",e)},toggle_fullscreen_editing:function(){var e=$(this.target).find(".CodeMirror-scroll");e.hasClass("fullscreen")?(e.removeClass("fullscreen"),e.height(this.toggle_fullscreen_editing.beforeFullscreen.height),e.width(this.toggle_fullscreen_editing.beforeFullscreen.width),this.editor.refresh()):(this.toggle_fullscreen_editing.beforeFullscreen={height:e.height(),width:e.width()},e.addClass("fullscreen"),e.height("100%"),e.width("100%"),this.editor.refresh())},undo:function(){this.editor.undo()},redo:function(){this.editor.redo()},cut:function(){this.copy(),this.editor.replaceSelection("")},copy:function(){var e=this.editor.getSelection();localStorage.clipboard=e},paste:function(){this.editor.replaceSelection(localStorage.clipboard)},do_delete:function(){this.editor.replaceSelection("")},select_all:function(){this.editor.setSelection({line:0,ch:0},{line:this.editor.lineCount(),ch:0})},get_selected_range:function(){return{from:this.editor.getCursor(!0),to:this.editor.getCursor(!1)}},auto_formatting:function(){var e=this.get_selected_range();this.editor.autoFormatRange(e.from,e.to)},comment_selection:function(){var e=this.get_selected_range();this.editor.commentRange(!0,e.from,e.to)},uncomment_selection:function(){var e=this.get_selected_range();this.editor.commentRange(!1,e.from,e.to)}};