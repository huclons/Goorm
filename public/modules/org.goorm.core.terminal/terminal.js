/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.terminal=function(){this.target=null,this.history=[],this.history_count=0,this.socket=null,this.ansi_color_codes=[{key:"30",css:"color:#000000;"},{key:"31",css:"color:#FF8888;"},{key:"32",css:"color:#88FF88;"},{key:"33",css:"color:yellow;"},{key:"34",css:"color:#8888FF;"},{key:"35",css:"color:#FF33FF;"},{key:"36",css:"color:cyan;"},{key:"37",css:"color:white;"},{key:"01",css:"font-weight:bold;"},{key:"04",css:"text-decoration:underline;"},{key:"40",css:"background-color:black;"},{key:"41",css:"background-color:#FF8888;"},{key:"42",css:"background-color:#88FF88;"},{key:"43",css:"background-color:yellow;"},{key:"44",css:"background-color:#8888FF;"},{key:"45",css:"background-color:#FF33FF;"},{key:"46",css:"background-color:cyan;"},{key:"47",css:"background-color:white;"}],this.ansi_color_code_regexp=/\[([0-9][0-9];?)* ?m/g,this.bash_text_reset=/\[0*m/g,this.user="",this.server="",this.path="",this.prompt_length=0,this.in_panel=!1,this.terminal_name="",this.index=-1,this.timestamp=null},org.goorm.core.terminal.prototype={init:function(e,t,n){var r=this;this.target=e,this.socket=io.connect(),this.in_panel=n,this.terminal_name=t,this.timestamp=new Date,$(e).addClass("terminal"),$(e).append("<div id='welcome'>welcome to goorm terminal :)</div>"),$(e).append("<div id='results'></div>"),$(e).append("<span id='prompt'><input id='prompt_input' class='prompt_input' /></div></span>"),r.timestamp=(new Date).getTime(),$(e).find("#prompt_input").keydown(function(e){if(e.keyCode=="13"){e.preventDefault();var t={index:r.index,command:$(this).val()};r.socket.emit("pty_execute_command",JSON.stringify(t)),r.history.push(t.command),r.history_count=r.history.length-1}else if(e.keyCode=="40")r.history_count<r.history.length-1&&r.history_count++,$(r.target).find("#prompt_input").val(r.history[r.history_count]);else if(e.keyCode=="38")r.history_count>0&&r.history_count--,$(r.target).find("#prompt_input").val(r.history[r.history_count]);else if(e.keyCode=="9"){e.preventDefault();var t={index:r.index,command:$(this).val()+"	"};r.socket.emit("pty_execute_command",t)}else if(e.keyCode!="99"&&e.keyCode!="67"||!e.ctrlKey)if(e.keyCode!="120"&&e.keyCode!="88"||!e.ctrlKey){if((e.keyCode=="122"||e.keyCode=="90")&&e.ctrlKey){e.preventDefault();var t={index:r.index,command:$(this).val()+""};r.socket.emit("pty_execute_command","")}}else{e.preventDefault();var t={index:r.index,command:$(this).val()+""};r.socket.emit("pty_execute_command","")}else{e.preventDefault();var t={index:r.index,command:$(this).val()+""};r.socket.emit("pty_execute_command","")}}),$(e).click(function(){$(r.target).find("#prompt_input").focus()});var i="";$(this).bind("got_index",function(){var e={index:r.index,project_path:core.status.current_project_path};r.socket.emit("change_project_dir",JSON.stringify(e))}),this.socket.on("on_change_project_dir",function(e){$(r).trigger("terminal_ready")}),this.socket.on("terminal_index",function(e){e=JSON.parse(e),r.index==-1&&r.timestamp==e.timestamp&&(r.index=parseInt(e.index),$(r).trigger("got_index"))});var s=null,o=function(e,t){if(e.terminal_name==r.terminal_name){var n=e.stdout;i+=n;if(t==1||/\n/.test(n)||n.indexOf("$")>-1){if(e.terminal_name=="debug"){var s=i.split("\n");$.each(s,function(e,t){$(core.module.debug).trigger("terminal_msg",t)})}i=i.replace("[H","").replace("[2J",""),i=i.replace(/\[\d[A-Z]/g,""),i=r.transform_bash_to_html(i),$(r.target).find("#results").append(i),i=""}$(r.target).find("#prompt_input").appendTo($(r.target).find("#results pre:last")),$(r.target).find("#prompt_input").val(""),$(r.target).find("#prompt_input").focus(),$(r.target).parent().parent().scrollTop(parseInt($(r.target).height()));if(n.indexOf("[2J")>-1){var o=$(r.target).find("#results pre").length;$(r.target).find("#results pre").each(function(e){o-1>e&&$(this).remove()})}var u=r.in_panel?"panel":"layout";r.resize_all(u)}};this.socket.on("pty_command_result",function(e){o(e),s&&clearTimeout(s),s=setTimeout(function(){i!=""&&o(e,1)},500)}),this.socket.emit("terminal_join",'{"timestamp": "'+this.timestamp+'", "workspace": "'+core.status.current_project_name+'", "terminal_name":"'+this.terminal_name+'"}'),$(core).bind("layout_resized",function(){r.resize_all("layout")}),$(this.target).bind("panel_resize",function(){r.resize_all("panel")}),$(this.target).bind("panel_close",function(){r.socket.emit("terminal_leave",'{"workspace": "'+core.status.current_project_name+'", "terminal_name":"'+r.terminal_name+'"}')}),this.resize_all()},change_project_dir:function(){var e=this;if(this.index!=-1){var t={index:e.index,project_path:core.status.current_project_path};e.socket.emit("change_project_dir",JSON.stringify(t))}},send_command:function(e){var t={index:this.index,command:e};this.socket.emit("pty_execute_command",JSON.stringify(t))},set_prompt:function(e){return e=e.replace("]0;",""),e=e.split("[")[0],e=e.split("@"),this.user=e[0],this.server=e[1].split(":")[0],this.path=e[1].split(":")[1],$(this.target).find("#prompt").find("#prompt_user").html(this.user),$(this.target).find("#prompt").find("#prompt_server").html(this.server),$(this.target).find("#prompt").find("#prompt_path").html(this.path),this.user+"@"+this.server+":"+this.path+"$ "},transform_bash_to_html:function(e){e=e.split("\n");for(var t=0;t<e.length;t++)if(e[t].indexOf("]0;")>-1)e[t]=this.set_prompt(e[t]);else{var n=e[t].split(this.bash_text_reset),r="";for(var i=0;i<n.length;i++){var s="";if(this.ansi_color_code_regexp.test(n[i])){var o=n[i].match(this.ansi_color_code_regexp),u="<span style='";for(var a=0;a<this.ansi_color_codes.length;a++)o[0].indexOf(this.ansi_color_codes[a].key)>-1&&(u+=this.ansi_color_codes[a].css);var f=n[i].replace(this.ansi_color_code_regexp,""),l=f.split(" ").join("&nbsp;");u+="'>"+l+"</span>"+"&nbsp;",n[i]=u}n[i]=n[i].split("	").join("&#9;")}r+=n.join(""),e[t]=r.replace(this.ansi_color_code_regexp,""),e[t].replace(/ */g,"")!="\r"&&(e[t]="<pre>"+e[t]+"</pre>")}return this.prompt_length=e[e.length-1].length,e=e.join(""),e},resize_all:function(e){if(self.in_panel&&e=="panel"){var t=$(this.target).parent().width()-20,n=$(this.target).parent().height()-50,r=$(this.target).find("#results").height()+20,i=(this.prompt_length+2)*9;$(this.target).find("#prompt_input").width(t-i),r<n?$(this.target).height(n):$(this.target).height(r)}else if(e=="layout"&&this.terminal_name!="debug"){var s=$(".yui-layout-unit-bottom").find(".yui-layout-wrap").width()-20,o=$(".yui-layout-unit-bottom").find(".yui-layout-wrap").height()-36,r=$(this.target).find("#results").height()+20,i=(this.prompt_length+2)*9;$(this.target).find("#prompt_input").width(s-i),r<o?$(this.target).height(o):$(this.target).height(r)}}};