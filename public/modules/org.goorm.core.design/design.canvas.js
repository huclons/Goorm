/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.design.canvas=function(){this.target=null,this.title=null,this.toolbar=null,this.width=null,this.height=null,this.skin_width=null,this.skin_height=null,this.snap_to_grid=!1,this.context_menu=null,this.objects=null,this.object_manager=null,this.focus=-1,this.inner_node=null,this.hovered_index=null,this.selected_index=null,this.is_drawing=!1,this.is_adding=-1,this.is_modifying=!1,this.is_double_clicking=0,this.previous_x=null,this.previous_y=null,this.sx=null,this.sy=null,this.ex=null,this.ey=null,this.copied_objects=null,this.copied_objects_undo=null,this.copied_objects_redo=null,this.undo_manager=null,this.dialog=null,this.preview=null,this.collaboration=null,this.object_explorer=null,this.multi_node_line=!1,this.preview_slider=null,this.is_shift_pressed=null},org.goorm.core.design.canvas.prototype={init:function(target,width,height,title,parent){var self=this;$(target).append("<div class='dummyspace'></div>"),$(target).append("<div class='space'></div>"),$(target).append("<div class='skin'></div>"),$(target).append("<div class='canvas'></div>"),$(target).find(".canvas").append("<div class='grid'></div>"),$(target).find(".canvas").append("<div class='shapes'></div>"),$(target).find(".canvas").append("<canvas width='"+width+"' height='"+height+"'></canvas>"),$(target).find(".canvas").append("<canvas width='"+width+"' height='"+height+"'></canvas>"),this.target=target,this.title=title,this.parent=parent,this.objects=[],this.copied_objects=[],this.copied_objects_undo=[],this.copied_objects_redo=[],this.is_adding=-1,this.is_modifying=!1,this.is_shift_pressed=!1,this.object_manager=new org.goorm.core.object.manager,this.object_manager.init("",this),this.object_explorer=new org.goorm.core.design.canvas.object_explorer,this.object_explorer.init(this),this.toolbar=new org.goorm.core.design.canvas.toolbar,this.toolbar.init(this);var empty_context_menu=new org.goorm.core.menu.context;empty_context_menu.init("","none",$(target).find(".design.preview_container"),""),this.collaboration=new org.goorm.core.collaboration.composing,this.collaboration.init(this),$(document).bind("line_stencil_code_loaded",function(){self.draw()}),$(document).bind("keydown","Shift",function(){self.is_shift_pressed=!0}),$(document).bind("keyup","Shift",function(){self.is_shift_pressed=!1});var handle_ok=function(){var e=$("#"+self.dialog.container_id).find(".design_canvas_setting").find(".canvas_width").val(),t=$("#"+self.dialog.container_id).find(".design_canvas_setting").find(".canvas_height").val();self.set_size(e,t),self.preview.scale=(self.preview_slider.get_real_value()/100).toFixed(2),self.preview.set_size("change"),parent.resize_all(),this.hide()},handle_cancel=function(){this.hide()};this.buttons=[{text:"OK",handler:handle_ok,isDefault:!0},{text:"Cancel",handler:handle_cancel}],this.dialog=new org.goorm.core.design.canvas.dialog,this.dialog.init({title:"Canvas Setting",path:"configs/dialogs/org.goorm.core.design/design.canvas.html",width:595,height:400,modal:!1,draggable:!0,buttons:this.buttons,success:function(){var e=new YAHOO.widget.TabView($("#"+self.dialog.container_id).find(".design_canvas_setting").get(0)),t=self.width;$("#"+self.dialog.container_id).find(".design_canvas_setting").find(".canvas_width").val(t);var n=self.height;$("#"+self.dialog.container_id).find(".design_canvas_setting").find(".canvas_height").val(n),self.preview_slider=YAHOO.widget.Slider.getHorizSlider("preview_slider_background","preview_slider_thumb",0,200,20),self.preview_slider.animate=!0,self.preview_slider.get_real_value=function(){return Math.round(this.getValue()/4+10)},self.preview_slider.subscribe("change",function(e){$("#preview_slider_value").empty(),$("#preview_slider_value").append(self.preview_slider.get_real_value())})}}),this.dialog=this.dialog.dialog,this.selected_index=[],this.set_size(width,height),this.context_menu=new org.goorm.core.menu.context,this.context_menu.init("configs/menu/org.goorm.core.design/design.canvas.html","design.canvas",$(target).find(".canvas").find("canvas"),this.title,"",function(){$("div[id='design.canvas_"+self.title+"']").find("a[action=paste_object]").click(function(){self.paste()}),$("div[id='design.canvas_"+self.title+"']").find("a[action=canvas_zoom_fit]").click(function(){self.toolbar.zoomFit()}),$("div[id='design.canvas_"+self.title+"']").find("a[action=canvas_zoom_in]").click(function(){self.toolbar.zoomIn()}),$("div[id='design.canvas_"+self.title+"']").find("a[action=canvas_zoom_out]").click(function(){self.toolbar.zoomOut()}),$("div[id='design.canvas_"+self.title+"']").find("a[action=canvas_snap_to_grid_on]").click(function(){self.toolbar.toggle_snap_to_grid()}),$("div[id='design.canvas_"+self.title+"']").find("a[action=show_canvas_setting]").click(function(){self.dialog.panel.show()})}),$(target).find(".canvas").find("canvas").dblclick(function(e){var parent_offset=$(this).parent().offset(),ratio=self.toolbar.zoom_level/100,x=Math.floor(e.pageX-parent_offset.left)*ratio,y=Math.floor(e.pageY-parent_offset.top)*ratio;$(self.objects).each(function(i){if(this.type=="square"){var sx=0,sy=0,ex=0,ey=0,shape_properties=this.shape.properties;$(this)[0].properties.sx&&(sx=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(sy=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(ex=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(ey=parseInt($(this)[0].properties.ey));var tInputWidth=Math.floor((ex-sx-20)/6),object_pointer=this;(sx-5<=x&&x<=ex+5||ex-5<=x&&x<=sx+5)&&(sy-5<=y&&y<=ey+5||ey-5<=y&&y<=sy+5)&&($("div[id='stencil_"+$(this)[0].shape.timestamp+"']").find("span").each(function(){var tsx=Math.floor($(this).offset().left-parent_offset.left),tsy=Math.floor($(this).offset().top-parent_offset.top),tex=Math.floor(tsx+$(this).width()),tey=Math.floor(tsy+$(this).height());if(tsx<=x&&x<=tex&&tsy<=y&&y<=tey){self.is_double_clicking=1e5;var tValue=$(this).text(),selected_object_key=this;$(this).empty(),$(this).append("<input type='text' value='"+tValue+"' size='"+tInputWidth+"'>"),$(this).find("input").focus(),$(this).find("input").bind("keypress",function(e){var code=e.keyCode?e.keyCode:e.which;if(code==13){var value=$(this).val();console.log(shape_properties),eval("shape_properties."+$(this).parent().attr("class")+"='"+value+"';"),$(selected_object_key).empty(),$(selected_object_key).append(tValue),self.select_item(i),self.is_double_clicking=3,object_pointer.properties.status="modified"}})}}),$("div[id='stencil_"+$(this)[0].shape.timestamp+"']").find("ul").each(function(){var tsx=Math.floor($(this).offset().left-parent_offset.left),tsy=Math.floor($(this).offset().top-parent_offset.top),tex=Math.floor(tsx+$(this).width()),tey=Math.floor(tsy+$(this).height());if(tsx<=x&&x<=tex&&tsy<=y&&y<=tey){self.is_double_clicking=1e5;var tValue=$(this).text(),selected_object_key=this;$(this).empty(),$(this).append("<input type='text' value='"+tValue+"' size='"+tInputWidth+"'>"),$(this).find("input").focus(),$(this).find("input").bind("keypress",function(e){var code=e.keyCode?e.keyCode:e.which;code==13&&(tValue=$(this).val(),eval("shape_properties."+$(this).parent().attr("class")+"='"+tValue+"';"),$(selected_object_key).empty(),$(selected_object_key).append(tValue),self.select_item(i),self.is_double_clicking=3,object_pointer.properties.status="modified")})}}))}}),$(self.target).find(".canvas").find(".grid").find(".selection").remove()}),$(target).find(".canvas").find("canvas").mousedown(function(e){if(e.which==1||e.which==3){self.sx=0,self.sy=0,self.ex=0,self.ey=0;var t=$(this).parent().offset(),n=self.toolbar.zoom_level/100,r=Math.floor(e.pageX-t.left)*n,i=Math.floor(e.pageY-t.top)*n;!$(self.target).find(".canvas").hasClass("status_drawing_line")&&!$(self.target).find(".canvas").hasClass("status_drawing_square")&&!$(self.target).find(".canvas").hasClass("status_move")&&!$(self.target).find(".canvas").hasClass("status_resize_top_left")&&!$(self.target).find(".canvas").hasClass("status_resize_top_right")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom_left")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom_right")&&!$(self.target).find(".canvas").hasClass("status_resize_top")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom")&&!$(self.target).find(".canvas").hasClass("status_resize_left")&&!$(self.target).find(".canvas").hasClass("status_resize_right")&&!self.is_drawing&&(self.sx=r,self.sy=i,$(self.target).find(".canvas").find(".grid").append("<div class='selection' style='display:none;'></div>"));var s=!1;$(self.target).find(".canvas").hasClass("status_drawing_line")?$(self.target).parent().find(".design_status_container").find(".lineDrawing").addClass("toolbar_buttonPressed"):$(self.target).find(".canvas").hasClass("status_drawing_square")?$(self.target).parent().find(".design_status_container").find(".squareDrawing").addClass("toolbar_buttonPressed"):($(self.target).parent().find(".design_status_container").find(".lineDrawing").removeClass("toolbar_buttonPressed"),$(self.target).parent().find(".design_status_container").find(".squareDrawing").removeClass("toolbar_buttonPressed")),$(self.objects).each(function(e){this.properties.selected_node=="body"&&(self.previous_x=r,self.previous_y=i),this.shape&&this.shape.move(r,i,r+1,i+1);if(this.type=="line")self.is_hovered(r,i,this,function(){self.selected_index.length<=1&&!self.is_shift_pressed&&(self.selected_index=[]),self.hovered_index==e&&(self.select_item(e),s=!0)});else if(this.type=="square"){var t=0,n=0,o=0,u=0;$(this)[0].properties.sx&&(t=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(n=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(o=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(u=parseInt($(this)[0].properties.ey)),(t-5<=r&&r<=o+5||o-5<=r&&r<=t+5)&&(n-5<=i&&i<=u+5||u-5<=i&&i<=n+5)&&(self.selected_index.length<=1&&!self.is_shift_pressed&&(self.selected_index=[]),self.hovered_index==e&&($.inArray(e,self.selected_index)>-1&&self.is_shift_pressed?self.selected_index.splice(self.selected_index.indexOf(e),1):(self.select_item(e),s=!0)))}}),!s&&!self.is_shift_pressed&&(self.deselect(),self.object_manager.unset()),self.draw(),self.context_menu.hide()}e.which==3&&self.hovered_index>-1&&self.context_menu.hide()}),$(target).find(".canvas").find("canvas").mousemove(function(e){if(self.is_double_clicking--<1){var t=$(this).parent().offset(),n=self.toolbar.zoom_level/100,r=Math.floor(e.pageX-t.left)*n,i=Math.floor(e.pageY-t.top)*n;$(target).parent().parent().parent().find(".ft").find(".mouse_position_view").html("("+r+", "+i+")"),$(self.target).find(".canvas").find(".grid").find(".selection")&&(self.ex=r,self.ey=i,self.ex-self.sx<0?$(self.target).find(".canvas").find(".grid").find(".selection").css("left",self.ex):$(self.target).find(".canvas").find(".grid").find(".selection").css("left",self.sx),self.ey-self.sy<0?$(self.target).find(".canvas").find(".grid").find(".selection").css("top",self.ey):$(self.target).find(".canvas").find(".grid").find(".selection").css("top",self.sy),$(self.target).find(".canvas").find(".grid").find(".selection").width(Math.abs(self.ex-self.sx)-4),$(self.target).find(".canvas").find(".grid").find(".selection").height(Math.abs(self.ey-self.sy)-4),$(self.target).find(".canvas").find(".grid").find(".selection").show()),self.hovered_index=null,!$(self.target).find(".canvas").hasClass("status_drawing_line")&&!$(self.target).find(".canvas").hasClass("status_drawing_square")&&self.change_status("status_default"),$(self.target).find(".canvas").hasClass("status_drawing_line")?$(self.target).parent().find(".design_status_container").find(".lineDrawing").addClass("toolbar_buttonPressed"):$(self.target).find(".canvas").hasClass("status_drawing_square")?$(self.target).parent().find(".design_status_container").find(".squareDrawing").addClass("toolbar_buttonPressed"):($(self.target).parent().find(".design_status_container").find(".lineDrawing").removeClass("toolbar_buttonPressed"),$(self.target).parent().find(".design_status_container").find(".squareDrawing").removeClass("toolbar_buttonPressed")),$(self.objects).each(function(e){this.shape&&this.properties.is_dragging&&!this.properties.is_drawing_finished&&(!self.is_modifying&&self.is_adding<0&&(delete self.copied_objects_undo,self.copied_objects_undo=[],$(self.selected_index).each(function(e){var t={};t.sx=self.objects[this].properties.sx,t.sy=self.objects[this].properties.sy,t.ex=self.objects[this].properties.ex,t.ey=self.objects[this].properties.ey,self.copied_objects_undo[this]=t}),self.is_modifying=!0),this.shape.show());if(this.properties.selected_node=="body"&&this.properties.is_dragging){self.move(e,r-this.properties.previous_x,i-this.properties.previous_y);var t=this;$(self.selected_index).each(function(n){e!=this&&(self.objects[this].properties.sx+=r-t.properties.previous_x,self.objects[this].properties.sy+=i-t.properties.previous_y,self.objects[this].type=="line"&&$(self.objects[this].properties.inner_node).each(function(e){this.x+=r-t.properties.previous_x,this.y+=i-t.properties.previous_y}),self.objects[this].properties.ex+=r-t.properties.previous_x,self.objects[this].properties.ey+=i-t.properties.previous_y,self.objects[this].properties.status="modified")})}if(this.type=="line"){var n=0,s=0,o=0,u=0;$(this)[0].properties.sx&&(n=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(s=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(o=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(u=parseInt($(this)[0].properties.ey)),self.is_hovered(r,i,this,function(){self.hover_item(e)});if(this.properties.selected_node=="head"&&this.properties.is_dragging){var a=this;$(self.objects).each(function(e){this.type=="square"&&(this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.sx=this.properties.sx,a.properties.sy=this.properties.sy):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.sx=Math.round((this.properties.sx+this.properties.ex)/2),a.properties.sy=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.sx=this.properties.ex,a.properties.sy=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10?(a.properties.sx=this.properties.ex,a.properties.sy=Math.round((this.properties.sy+this.properties.ey)/2)):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.sx=this.properties.ex,a.properties.sy=this.properties.ey):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.sx=Math.round((this.properties.sx+this.properties.ex)/2),a.properties.sy=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.sx=this.properties.sx,a.properties.sy=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10&&(a.properties.sx=this.properties.sx,a.properties.sy=Math.round((this.properties.sy+this.properties.ey)/2)))})}else if(this.properties.selected_node=="tail"&&this.properties.is_dragging){var a=this;$(self.objects).each(function(e){this.type=="square"&&(this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.ex=this.properties.sx,a.properties.ey=this.properties.sy):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.ex=Math.round((this.properties.sx+this.properties.ex)/2),a.properties.ey=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(a.properties.ex=this.properties.ex,a.properties.ey=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10?(a.properties.ex=this.properties.ex,a.properties.ey=Math.round((this.properties.sy+this.properties.ey)/2)):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.ex=this.properties.ex,a.properties.ey=this.properties.ey):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.ex=Math.round((this.properties.sx+this.properties.ex)/2),a.properties.ey=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(a.properties.ex=this.properties.sx,a.properties.ey=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10&&(a.properties.ex=this.properties.sx,a.properties.ey=Math.round((this.properties.sy+this.properties.ey)/2)))})}}else if(this.type=="square"){var n=0,s=0,o=0,u=0;$(this)[0].properties.sx&&(n=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(s=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(o=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(u=parseInt($(this)[0].properties.ey)),(n-5<=r&&r<=o+5||o-5<=r&&r<=n+5)&&(s-5<=i&&i<=u+5||u-5<=i&&i<=s+5)&&self.hover_item(e)}}),self.draw()}}),$(target).find(".canvas").find("canvas").mouseup(function(e){self.is_drawing=!1;var t=$(this).parent().offset(),n=self.toolbar.zoom_level/100,r=Math.floor(e.pageX-t.left)*n,i=Math.floor(e.pageY-t.top)*n;if(e.which==1){if(!$(self.target).find(".canvas").hasClass("status_drawing_line")&&!$(self.target).find(".canvas").hasClass("status_drawing_square")&&!$(self.target).find(".canvas").hasClass("status_move")&&!$(self.target).find(".canvas").hasClass("status_resize_top_left")&&!$(self.target).find(".canvas").hasClass("status_resize_top_right")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom_left")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom_right")&&!$(self.target).find(".canvas").hasClass("status_resize_top")&&!$(self.target).find(".canvas").hasClass("status_resize_bottom")&&!$(self.target).find(".canvas").hasClass("status_resize_left")&&!$(self.target).find(".canvas").hasClass("status_resize_right")&&!self.is_drawing)$(self.target).find(".canvas").find(".grid").find(".selection")&&($(self.target).find(".canvas").find(".grid").find(".selection").width()>=5||$(self.target).find(".canvas").find(".grid").find(".selection").height()>=5)&&self.select(),$(self.target).find(".canvas").find(".grid").find(".selection").remove(),self.sx=0,self.sy=0,self.ex=0,self.ey=0;else if(self.is_adding>-1&&self.objects[self.is_adding]!=undefined){var s={};console.log(self.objects),console.log(self.is_adding),s.sx=self.objects[self.is_adding].properties.sx,s.sy=self.objects[self.is_adding].properties.sy,s.ex=self.objects[self.is_adding].properties.ex,s.ey=self.objects[self.is_adding].properties.ey,self.is_adding=-1}Math.abs(r-self.previous_x)<4&&Math.abs(i-self.previous_y)<4&&(self.is_shift_pressed||(self.deselect(),self.object_manager.unset()),self.hovered_index>=0&&self.selected_index.length==0&&self.select_item(self.hovered_index)),$(self.target).find(".canvas").hasClass("status_drawing_line")?$(self.target).parent().find(".design_status_container").find(".lineDrawing").addClass("toolbar_buttonPressed"):$(self.target).find(".canvas").hasClass("status_drawing_square")?$(self.target).parent().find(".design_status_container").find(".squareDrawing").addClass("toolbar_buttonPressed"):($(self.target).parent().find(".design_status_container").find(".lineDrawing").removeClass("toolbar_buttonPressed"),$(self.target).parent().find(".design_status_container").find(".squareDrawing").removeClass("toolbar_buttonPressed")),$(self.objects).each(function(e){if(self.snap_to_grid){var t=parseInt(core.preference["preference.designer.grid_unit"]);this.properties.sx%t<t/4?this.properties.sx-=this.properties.sx%t:this.properties.sx%t>t*3/4&&(this.properties.sx=parseInt(Math.round(this.properties.sx/t))*t),this.properties.sy%t<t/4?this.properties.sy-=this.properties.sy%t:this.properties.sy%t>t*3/4&&(this.properties.sy=parseInt(Math.round(this.properties.sy/t))*t),this.properties.ex%t<t/4?this.properties.ex-=this.properties.ex%t:this.properties.ex%t>t*3/4&&(this.properties.ex=parseInt(Math.round(this.properties.ex/t))*t),this.properties.ey%t<t/4?this.properties.ey-=this.properties.ey%t:this.properties.ey%t>t*3/4&&(this.properties.ey=parseInt(Math.round(this.properties.ey/t))*t)}if(this.type=="line")if(this.properties.selected_node=="head"){var n=this;$(self.objects).each(function(t){this.type=="square"&&(this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.head=t,this.properties.connector.tl=e,n.properties.sx=this.properties.sx,n.properties.sy=this.properties.sy):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.head=t,this.properties.connector.t=e,n.properties.sx=Math.round((this.properties.sx+this.properties.ex)/2),n.properties.sy=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.head=t,this.properties.connector.tr=e,n.properties.sx=this.properties.ex,n.properties.sy=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10?(n.properties.connector.head=t,this.properties.connector.r=e,n.properties.sx=this.properties.ex,n.properties.sy=Math.round((this.properties.sy+this.properties.ey)/2)):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.head=t,this.properties.connector.br=e,n.properties.sx=this.properties.ex,n.properties.sy=this.properties.ey):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.head=t,this.properties.connector.b=e,n.properties.sx=Math.round((this.properties.sx+this.properties.ex)/2),n.properties.sy=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.head=t,this.properties.connector.bl=e,n.properties.sx=this.properties.sx,n.properties.sy=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10&&(n.properties.connector.head=t,this.properties.connector.l=e,n.properties.sx=this.properties.sx,n.properties.sy=Math.round((this.properties.sy+this.properties.ey)/2)))})}else if(this.properties.selected_node=="tail"){var n=this;$(self.objects).each(function(t){this.type=="square"&&(this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.tail=t,this.properties.connector.tl=e,n.properties.ex=this.properties.sx,n.properties.ey=this.properties.sy):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.tail=t,this.properties.connector.t=e,n.properties.ex=Math.round((this.properties.sx+this.properties.ex)/2),n.properties.ey=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.sy-10<=i&&i<=this.properties.sy+10?(n.properties.connector.tail=t,this.properties.connector.tr=e,n.properties.ex=this.properties.ex,n.properties.ey=this.properties.sy):this.properties.ex-10<=r&&r<=this.properties.ex+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10?(n.properties.connector.tail=t,this.properties.connector.r=e,n.properties.ex=this.properties.ex,n.properties.ey=Math.round((this.properties.sy+this.properties.ey)/2)):this.properties.ex-10<=r&&r<=this.properties.ex+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.tail=t,this.properties.connector.br=e,n.properties.ex=this.properties.ex,n.properties.ey=this.properties.ey):(this.properties.sx+this.properties.ex)/2-10<=r&&r<=(this.properties.sx+this.properties.ex)/2+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.tail=t,this.properties.connector.b=e,n.properties.ex=Math.round((this.properties.sx+this.properties.ex)/2),n.properties.ey=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&this.properties.ey-10<=i&&i<=this.properties.ey+10?(n.properties.connector.tail=t,this.properties.connector.bl=e,n.properties.ex=this.properties.sx,n.properties.ey=this.properties.ey):this.properties.sx-10<=r&&r<=this.properties.sx+10&&(this.properties.sy+this.properties.ey)/2-10<=i&&i<=(this.properties.sy+this.properties.ey)/2+10&&(n.properties.connector.tail=t,this.properties.connector.l=e,n.properties.ex=this.properties.sx,n.properties.ey=Math.round((this.properties.sy+this.properties.ey)/2)))})}else if(this.properties.selected_node=="body"){var n=this;n.properties.connector.head=null,n.properties.connector.tail=null,$(self.objects).each(function(t){this.type=="square"&&(this.properties.connector["tl"]==e?this.properties.connector.tl=null:this.properties.connector["t"]==e?this.properties.connector.t=null:this.properties.connector["tr"]==e?this.properties.connector.tr=null:this.properties.connector["r"]==e?this.properties.connector.r=null:this.properties.connector["br"]==e?this.properties.connector.br=null:this.properties.connector["b"]==e?this.properties.connector.b=null:this.properties.connector["bl"]==e?this.properties.connector.bl=null:this.properties.connector["l"]==e&&(this.properties.connector.l=null))})}}),self.is_modifying&&(delete self.copied_objects_redo,self.copied_objects_redo=[],$(self.selected_index).each(function(e){var t={};t.sx=self.objects[this].properties.sx,t.sy=self.objects[this].properties.sy,t.ex=self.objects[this].properties.ex,t.ey=self.objects[this].properties.ey,self.copied_objects_redo[this]=t,self.object_manager.set(self.objects[this])}),self.is_modifying=!1),self.draw(),$(self.collaboration).trigger("modify",[self.objects[self.hovered_index]])}this.focus=-1,self.object_explorer.refresh()})},is_hovered:function(e,t,n,r){var i=0,s=0,o=0,u=0;n.properties.sx&&(i=parseInt(n.properties.sx)),n.properties.sy&&(s=parseInt(n.properties.sy)),n.properties.ex&&(o=parseInt(n.properties.ex)),n.properties.ey&&(u=parseInt(n.properties.ey));if(n.properties.inner_node!=null)for(var a=0;a<=n.properties.inner_node.length;a++){a==0?n.properties.inner_node.length==0?(i=n.properties.sx,s=n.properties.sy,o=n.properties.ex,u=n.properties.ey):(i=n.properties.sx,s=n.properties.sy,o=n.properties.inner_node[0].x,u=n.properties.inner_node[0].y):a==n.properties.inner_node.length?(i=n.properties.inner_node[a-1].x,s=n.properties.inner_node[a-1].y,o=n.properties.ex,u=n.properties.ey):(i=n.properties.inner_node[a-1].x,s=n.properties.inner_node[a-1].y,o=n.properties.inner_node[a].x,u=n.properties.inner_node[a].y);if((i-5<=e&&e<=o+5||o-5<=e&&e<=i+5)&&(s-5<=t&&t<=u+5||u-5<=t&&t<=s+5)){var f,l,c,h=5;if(o-i!=0){f=(u-s)/(o-i),h=Math.round(5*Math.sqrt(f*f+1)*1e3)/1e3,l=s-f*i-h,c=s-f*i+h;if(Math.round(Math.abs(f)*1e3)/1e3<.01||Math.round(Math.abs(1/f)*1e3)/1e3<.01){if(typeof r=="function"){r();return}}else if(f*e+l<=t&&t<=f*e+c&&((t-l)/f<=e&&e<=(t-c)/f||(t-c)/f<=e&&e<=(t-l)/f)&&typeof r=="function"){r();return}}else if(typeof r=="function"){r();return}}}},set_size:function(e,t,n){this.width=parseInt(e),this.height=parseInt(t),$(this.target).find(".canvas").width(this.width),$(this.target).find(".canvas").height(this.height),$(this.target).find(".canvas").css("margin-left",0-this.width/2),$(this.target).find(".canvas").css("margin-top",0-this.height/2),$(this.target).find(".canvas").find(".shapes").css("position","absolute"),$(this.target).find(".canvas").find(".shapes").css("left",0),$(this.target).find(".canvas").find(".shapes").css("top",0),$(this.target).find(".canvas").find("canvas").css("position","absolute"),$(this.target).find(".canvas").find("canvas").css("left",0),$(this.target).find(".canvas").find("canvas").css("top",0),$(this.target).find(".canvas").find("canvas").css("width",this.width),$(this.target).find(".canvas").find("canvas").css("height",this.height),$(this.target).find(".canvas").find("canvas").attr("width",this.width),$(this.target).find(".canvas").find("canvas").attr("height",this.height),$(this.target).find(".space").width(this.width+90),$(this.target).find(".space").height(this.height+100),$(this.target).find(".dummyspace").width(this.width+90),$(this.target).find(".dummyspace").height(this.height+100)},set_skin:function(e,t,n){this.skin_width=parseInt(t),this.skin_height=parseInt(n),$(this.target).find(".skin").width(this.skin_width),$(this.target).find(".skin").height(this.skin_height),$(this.target).find(".skin").css("margin-left",0-this.skin_width/2),$(this.target).find(".skin").css("margin-top",0-this.skin_height/2),$(this.target).find(".skin").css("background-image","url("+e+")"),$(this.target).find(".space").width(this.skin_width+90),$(this.target).find(".space").height(this.skin_height+100)},add:function(e,t,n,r,i){var s=this;if(!s.is_drawing){s.is_drawing=!0;var o=new org.goorm.core.object.ui;o.init($(s.target).find(".canvas"),s,e,t,n,function(){typeof i=="function"&&i()}),s.objects.push(o),s.is_adding=s.objects.length-1,r&&(s.objects[s.objects.length-1].properties.sx=r.sx,s.objects[s.objects.length-1].properties.sy=r.sy,s.objects[s.objects.length-1].properties.ex=r.ex,s.objects[s.objects.length-1].properties.ey=r.ey,s.objects[s.objects.length-1].properties.is_drawing_finished=!0,s.is_drawing=!1,s.is_adding=-1,s.objects[s.objects.length-1].shape.show(),s.draw()),s.object_explorer.refresh(),$(this.collaboration).trigger("add",[s.objects[s.objects.length-1]])}},select_all:function(){var e=this;$(this.objects).each(function(t){e.select_item(t)})},select:function(){var e=this;$(this.objects).each(function(t){var n=0,r=0;this.selected=!1,$(this)[0].properties.sx&&(n=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(r=parseInt($(this)[0].properties.sy));if((e.sx<=n&&n<=e.ex||e.ex<=n&&n<=e.sx)&&(e.sy<=r&&r<=e.ey||e.ey<=r&&r<=e.sy)){var i=0,s=0;$(this)[0].properties.ex&&(i=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(s=parseInt($(this)[0].properties.ey)),(e.sx<=i&&i<=e.ex||e.ex<=i&&i<=e.sx)&&(e.sy<=s&&s<=e.ey||e.ey<=s&&s<=e.sy)&&(e.selected_index.push(t),this.selected=!0,e.object_explorer.highlight(t),e.object_manager.set(this))}})},deselect:function(){var e=this;$(this.objects).each(function(t){e.selected_index.pop()}),$("#object_explorer").find(".highlighted").each(function(e){$(this).removeClass("highlighted")})},unfocus_all:function(){var e=this;this.focus=-1,$(this.objects).each(function(e){this.properties.focus=!1})},draw:function(){var self=this;this.selected_index=$.unique(this.selected_index);if($(this.target).find(".canvas").find("canvas")[0].getContext){var context=$(this.target).find(".canvas").find("canvas")[0].getContext("2d");context.clearRect(0,0,$(this.target).find(".canvas").find("canvas").width(),$(this.target).find(".canvas").find("canvas").height()),$(this.objects).each(function(i){if(this.properties.timestamp==null){var a=self.objects.slice(0,i),b=self.objects.slice(i,self.objects.length);b.shift(),self.objects=a.concat(b)}if($(this)[0].type=="line"){var sx=0,sy=0,ex=0,ey=0;$(this)[0].properties.sx&&(sx=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(sy=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(ex=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(ey=parseInt($(this)[0].properties.ey)),self.hovered_index==i&&(context.beginPath(),context.strokeStyle="#FFFF00",context.moveTo(sx,sy),$(this.properties.inner_node).each(function(){context.lineTo(this.x,this.y)}),context.lineTo(ex,ey),context.lineWidth=parseFloat($(this)[0].properties.thickness)+5
,context.stroke()),context.beginPath(),context.strokeStyle=$(this)[0].properties.color;if(this.properties.dashed){var dash_array=[5*parseFloat($(this)[0].properties.thickness),4*parseFloat($(this)[0].properties.thickness)],dash_count=dash_array.length,dx,dy,dash_index=0,draw=!0,x,y;ex<sx?(x=ex,y=ey):(x=sx,y=sy),context.moveTo(x,y),context.lineWidth=parseFloat($(this)[0].properties.thickness),$(this.properties.inner_node).each(function(){dx=x-this.x,dy=y-this.y;var e=dy/dx,t=Math.sqrt(dx*dx+dy*dy);while(t>=.1){var n=dash_array[dash_index++%dash_count];n>t&&(n=t);var r=Math.sqrt(n*n/(1+e*e));x+=r,y+=e*r,context[draw?"lineTo":"moveTo"](x,y),t-=n,draw=!draw}x=this.x,y=this.y}),ex<sx?(dx=x-sx,dy=y-sy):(dx=x-ex,dy=y-ey);var slope=dy/dx,remaining_distance=Math.sqrt(dx*dx+dy*dy);while(remaining_distance>=.1){var dash_length=dash_array[dash_index++%dash_count];dash_length>remaining_distance&&(dash_length=remaining_distance);var step_x=Math.sqrt(dash_length*dash_length/(1+slope*slope));x+=step_x,y+=slope*step_x,context[draw?"lineTo":"moveTo"](x,y),remaining_distance-=dash_length,draw=!draw}context.stroke()}else context.moveTo(sx,sy),$(this.properties.inner_node).each(function(){context.lineTo(this.x,this.y)}),context.lineTo(ex,ey),context.lineWidth=parseFloat($(this)[0].properties.thickness),context.stroke();if(this.shape){var temp_sx=this.properties.sx,temp_sy=this.properties.sy,temp_ex=this.properties.ex,temp_ey=this.properties.ey;this.properties.inner_node.length>0&&(temp_sx=this.properties.inner_node[this.properties.inner_node.length-1].x,temp_sy=this.properties.inner_node[this.properties.inner_node.length-1].y,temp_ex=this.properties.inner_node[0].x,temp_ey=this.properties.inner_node[0].y),eval(this.shape.javascript)}if($.inArray(i,self.selected_index)>=0||self.selected)context.beginPath(),context.strokeStyle="#666666",context.rect(sx-3,sy-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fillStyle="#FFFFFF",context.fill(),$(this.properties.inner_node).each(function(e){context.beginPath(),context.strokeStyle="#666666",context.rect(this.x-3,this.y-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fillStyle="#FFFFFF",context.fill()}),context.beginPath(),context.strokeStyle="#666666",context.rect(ex-3,ey-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fillStyle="#FFFFFF",context.fill()}else if($(this)[0].type=="square"){var sx=0,sy=0,ex=0,ey=0;$(this)[0].properties.sx&&(sx=parseInt($(this)[0].properties.sx)),$(this)[0].properties.sy&&(sy=parseInt($(this)[0].properties.sy)),$(this)[0].properties.ex&&(ex=parseInt($(this)[0].properties.ex)),$(this)[0].properties.ey&&(ey=parseInt($(this)[0].properties.ey)),self.hovered_index==i&&(context.beginPath(),context.strokeStyle="#FFFF00",context.rect(sx,sy,ex-sx,ey-sy),context.lineWidth=5,context.closePath(),context.stroke(),context.beginPath(),context.strokeStyle="#000000",context.fillStyle="#FFFFFF",context.rect(sx,sy,ex-sx,ey-sy),context.lineWidth=.5,context.closePath(),context.stroke());if($.inArray(i,self.selected_index)>=0||self.selected)context.beginPath(),context.strokeStyle="#666666",context.fillStyle="#FFFFFF",context.rect(sx-3,sy-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect(ex-3,sy-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect(ex-3,ey-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect(sx-3,ey-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect((sx+ex)/2-3,ey-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect((sx+ex)/2-3,sy-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect(ex-3,(sy+ey)/2-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill(),context.rect(sx-3,(sy+ey)/2-3,6,6),context.closePath(),context.lineWidth=1,context.stroke(),context.fill();this.shape&&this.shape.move&&(this.shape.move(this.properties.sx,this.properties.sy,this.properties.ex,this.properties.ey),this.shape.set_shape())}})}},set_cursor:function(e){$(this.target).find(".canvas").css("cursor",e)},set_drawing_mode:function(e){$(this.target).find(".canvas").removeClass("status_default"),$(this.target).find(".canvas").removeClass("status_drawing_line"),$(this.target).find(".canvas").removeClass("status_drawing_square"),$(this.target).find(".canvas").removeClass("status_move"),$(this.target).find(".canvas").removeClass("status_resize_top_left"),$(this.target).find(".canvas").removeClass("status_resize_top_right"),$(this.target).find(".canvas").removeClass("status_resize_bottom_left"),$(this.target).find(".canvas").removeClass("status_resize_bottom_right"),$(this.target).find(".canvas").removeClass("status_resize_top"),$(this.target).find(".canvas").removeClass("status_resize_bottom"),$(this.target).find(".canvas").removeClass("status_resize_left"),$(this.target).find(".canvas").removeClass("status_resize_right"),$(this.target).parent().find(".design_status_container").find(".lineDrawing").removeClass("toolbar_buttonPressed"),$(this.target).parent().find(".design_status_container").find(".squareDrawing").removeClass("toolbar_buttonPressed"),e=="line"?$(this.target).find(".canvas").addClass("status_drawing_line"):e=="square"&&$(this.target).find(".canvas").addClass("status_drawing_square")},change_status:function(e){$(this.target).find(".canvas").removeClass("status_default"),$(this.target).find(".canvas").removeClass("status_drawing_line"),$(this.target).find(".canvas").removeClass("status_drawing_square"),$(this.target).find(".canvas").removeClass("status_move"),$(this.target).find(".canvas").removeClass("status_resize_top_left"),$(this.target).find(".canvas").removeClass("status_resize_top_right"),$(this.target).find(".canvas").removeClass("status_resize_bottom_left"),$(this.target).find(".canvas").removeClass("status_resize_bottom_right"),$(this.target).find(".canvas").removeClass("status_resize_top"),$(this.target).find(".canvas").removeClass("status_resize_bottom"),$(this.target).find(".canvas").removeClass("status_resize_left"),$(this.target).find(".canvas").removeClass("status_resize_right"),$(this.target).find(".canvas").addClass(e)},highlight_object:function(e){$("#object_tree").find(".ygtvcontent").each(function(t){"objectInformation"+e==$(this).text()?$(this).parent().parent().parent().parent().addClass("highlighted"):$(this).parent().parent().parent().parent().removeClass("highlighted")})},unhighlight_object:function(e){this.object_explorer.unhighlight(e)},select_item:function(e){this.is_shift_pressed||this.unfocus_all(),this.focus=e;if(this.objects[e]){this.objects[e].properties.focus=!0,this.selected_index.push(e),this.change_status("status_move"),this.object_manager.set(this.objects[e]),this.highlight_object(e);if(this.objects[e].type=="line"){var t;this.objects[e].properties.connector["head"]!=null&&(t=this.objects[e].properties.connector.head,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["tail"]!=null&&(t=this.objects[e].properties.connector.tail,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t))}else if(this.objects[e].type=="square"){var t;this.objects[e].properties.connector["tl"]!=null&&(t=this.objects[e].properties.connector.tl,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["t"]!=null&&(t=this.objects[e].properties.connector.t,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["tr"]!=null&&(t=this.objects[e].properties.connector.tr,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["r"]!=null&&(t=this.objects[e].properties.connector.r,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["br"]!=null&&(t=this.objects[e].properties.connector.br,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["b"]!=null&&(t=this.objects[e].properties.connector.b,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["bl"]!=null&&(t=this.objects[e].properties.connector.bl,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t)),this.objects[e].properties.connector["l"]!=null&&(t=this.objects[e].properties.connector.l,this.objects[t].properties.focus=!0,this.selected_index.push(t),this.highlight_object(t))}}},deselect_item:function(e){!$(this.target).find(".canvas").hasClass("status_drawing_line")&&!$(this.target).find(".canvas").hasClass("status_drawing_square")&&this.change_status("status_default"),this.focus>e&&(this.focus=-1,this.objects[e].properties.focus=!1),this.unhighlight_object(e)},hover_item:function(e){this.hovered_index=e,this.change_status("status_move"),this.highlight_object(e)},move:function(e,t,n){if(this.objects[e].type!="line"&&this.objects[e].type=="square"){var r;this.objects[e].properties.connector["tl"]!=null&&(r=this.objects[e].properties.connector.tl,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["t"]!=null&&(r=this.objects[e].properties.connector.t,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["tr"]!=null&&(r=this.objects[e].properties.connector.tr,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["r"]!=null&&(r=this.objects[e].properties.connector.r,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["br"]!=null&&(r=this.objects[e].properties.connector.br,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["b"]!=null&&(r=this.objects[e].properties.connector.b,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["bl"]!=null&&(r=this.objects[e].properties.connector.bl,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e),this.objects[e].properties.connector["l"]!=null&&(r=this.objects[e].properties.connector.l,this.objects[r].properties.connector["tail"]!=null&&this.objects[r].properties.connector["tail"]==e,this.objects[r].properties.connector["head"]!=null&&this.objects[r].properties.connector["head"]==e)}$(this.collaboration).trigger("modify",[this.objects[e]])},bring_forward:function(e){e||(e=this.objects[this.focus]);var t=-1;$(this.objects).each(function(n){this.properties.timestamp==e.properties.timestamp&&(t=n)});if(this.objects.length-1>t&&t>=0){var n=$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html();$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).remove(),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t+1].shape.timestamp).after("<div id='stencil_"+this.objects[t].shape.timestamp+"' style='position:absolute; display:none;'></div>"),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html(n),this.objects[t].shape.move(this.objects[t].properties.sx,this.objects[t].properties.sy,this.objects[t].properties.ex,this.objects[t].properties.ey),this.objects[t].shape.show(),this.objects=$(this.objects).move(t,t+1),this.focus++}},send_backward:function(e){e||(e=this.objects[this.focus]);var t=-1;$(this.objects).each(function(n){this.properties.timestamp==e.properties.timestamp&&(t=n)});if(this.objects.length>t&&t>0){var n=$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html();$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).remove(),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t-1].shape.timestamp).before("<div id='stencil_"+this.objects[t].shape.timestamp+"' style='position:absolute; display:none;'></div>"),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html(n),this.objects[t].shape.move(this.objects[t].properties.sx,this.objects[t].properties.sy,this.objects[t].properties.ex,this.objects[t].properties.ey),this.objects[t].shape.show(),this.objects=$(this.objects).move(t,t-1),this.focus--}},bring_to_front:function(e){e||(e=this.objects[this.focus]);var t=-1;$(this.objects).each(function(n){this.properties.timestamp==e.properties.timestamp&&(t=n)});var n=$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html();$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).remove(),$(this.target).find(".canvas").find(".shapes").append("<div id='stencil_"+this.objects[t].shape.timestamp+"' style='position:absolute; display:none;'></div>"),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html(n),this.objects[t].shape.move(this.objects[t].properties.sx,this.objects[t].properties.sy,this.objects[t].properties.ex,this.objects[t].properties.ey),this.objects[t].shape.show(),this.objects=$(this.objects).move(t,this.objects.length-1),this.focus=this.objects.length-1},send_to_back:function(e){e||(e=this.objects[this.focus]);var t=-1;$(this.objects).each(function(n){this.properties.timestamp==e.properties.timestamp&&(t=n)});var n=$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html();$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).remove(),$(this.target).find(".canvas").find(".shapes").prepend("<div id='stencil_"+this.objects[t].shape.timestamp+"' style='position:absolute; display:none;'></div>"),$(this.target).find(".canvas").find(".shapes").find("#stencil_"+this.objects[t].shape.timestamp).html(n),this.objects[t].shape.move(this.objects[t].properties.sx,this.objects[t].properties.sy,this.objects[t].properties.ex,this.objects[t].properties.ey),this.objects[t].shape.show(),this.objects=$(this.objects).move(t,0),this.focus=0},align_left:function(){var e=this,t=0;$(this.selected_index).each(function(n){n==0&&(t=e.objects[this].properties.sx),e.objects[this].properties.sx<e.objects[this].properties.ex?e.objects[this].properties.sx<t&&(t=e.objects[this].properties.sx):e.objects[this].properties.ex<t&&(t=e.objects[this].properties.ex)}),$(this.selected_index).each(function(n){e.objects[this].properties.sx<e.objects[this].properties.ex?(e.objects[this].properties.ex-=e.objects[this].properties.sx-t,e.objects[this].properties.sx=t):(e.objects[this].properties.sx-=e.objects[this].properties.ex-t,e.objects[this].properties.ex=t)}),this.draw()},align_right:function(){var e=this,t=0;$(this.selected_index).each(function(n){e.objects[this].properties.sx<e.objects[this].properties.ex?e.objects[this].properties.ex>t&&(t=e.objects[this].properties.ex):e.objects[this].properties.sx>t&&(t=e.objects[this].properties.sx)}),$(this.selected_index).each(function(n){e.objects[this].properties.sx<e.objects[this].properties.ex?(e.objects[this].properties.sx+=t-e.objects[this].properties.ex,e.objects[this].properties.ex=t):(e.objects[this].properties.ex+=t-e.objects[this].properties.sx,e.objects[this].properties.sx=t)}),this.draw()},align_top:function(){var e=this,t=0;$(this.selected_index).each(function(n){n==0&&(t=e.objects[this].properties.sy),e.objects[this].properties.sy<e.objects[this].properties.ey?e.objects[this].properties.sy<t&&(t=e.objects[this].properties.sy):e.objects[this].properties.ey<t&&(t=e.objects[this].properties.ey)}),$(this.selected_index).each(function(n){e.objects[this].properties.sy<e.objects[this].properties.ey?(e.objects[this].properties.ey-=e.objects[this].properties.sy-t,e.objects[this].properties.sy=t):(e.objects[this].properties.sy-=e.objects[this].properties.ey-t,e.objects[this].properties.ey=t)}),this.draw()},align_bottom:function(){var e=this,t=0;$(this.selected_index).each(function(n){e.objects[this].properties.sy<e.objects[this].properties.ey?e.objects[this].properties.ey>t&&(t=e.objects[this].properties.ey):e.objects[this].properties.sy>t&&(t=e.objects[this].properties.sy)}),$(this.selected_index).each(function(n){e.objects[this].properties.sy<e.objects[this].properties.ey?(e.objects[this].properties.sy+=t-e.objects[this].properties.ey,e.objects[this].properties.ey=t):(e.objects[this].properties.ey+=t-e.objects[this].properties.sy,e.objects[this].properties.sy=t)}),this.draw()},align_horizontally_center:function(){var e=this,t=0;t=(e.objects[this.selected_index[0]].properties.sx+e.objects[this.selected_index[0]].properties.ex)/2,$(this.selected_index).each(function(n){var r=Math.abs(e.objects[this].properties.ex-e.objects[this].properties.sx)/2;e.objects[this].properties.sx<e.objects[this].properties.ex?(e.objects[this].properties.sx=t-r,e.objects[this].properties.ex=t+r):(e.objects[this].properties.ex=t-r,e.objects[this].properties.sx=t+r)}),this.draw()},align_vertically_center:function(){var e=this,t=0;t=(e.objects[this.selected_index[0]].properties.sy+e.objects[this.selected_index[0]].properties.ey)/2,$(this.selected_index).each(function(n){var r=Math.abs(e.objects[this].properties.ey-e.objects[this].properties.sy)/2;e.objects[this].properties.sy<e.objects[this].properties.ey?(e.objects[this].properties.sy=t-r,e.objects[this].properties.ey=t+r):(e.objects[this].properties.ey=t-r,e.objects[this].properties.sy=t+r)}),this.draw()},_delete:function(){var e=this;$(this.selected_index).each(function(t){$(e.collaboration).trigger("remove",[e.objects[this].properties.id]),e.objects[this].remove()})},cut:function(){var e=this;delete this.copied_objects,this.copied_objects=[],$(this.selected_index).each(function(t){e.copied_objects.push(e.clone(e.objects[this])),e.objects[this].remove()})},copy:function(){var e=this;delete this.copied_objects,this.copied_objects=[],$(this.selected_index).each(function(t){e.copied_objects.push(e.clone(e.objects[this]))})},paste:function(){var e=this,t=e.objects.length;$(this.copied_objects).each(function(n){e.is_drawing=!1;var r=this;e.add(this.type,this.shape_name,null,null,function(){e.set_shape_properties(e.objects[t+n],r),e.objects[t+n].shape.show(),e.objects[t+n].shape.set_shape(),e.draw()}),e.set_properties(e.objects[t+n],this),e.objects[t+n].properties.sx+=10,e.objects[t+n].properties.sy+=10,e.objects[t+n].properties.ex+=10,e.objects[t+n].properties.ey+=10}),this.draw(),delete this.copied_objects},load:function(e){var t=this;delete this.objects,this.objects=[],$(this.target).find(".canvas").find(".shapes").empty(),$(e).each(function(e){t.is_drawing=!1;var n=this;t.add(this.type,this.shape_name,null,null,function(){t.set_shape_properties(t.objects[e],n),t.objects[e].shape.show(),t.objects[e].shape.set_shape(),t.draw()}),t.set_properties(t.objects[e],this)}),this.draw()},clone:function(e){var t={};for(var n in e)if(typeof e[n]=="object"){var r=e[n],i={};for(var s in r)if(typeof r[s]=="object"){var o=r[s],u={};for(var a in o)typeof o[a]!="object"&&(u[a]=o[a]);i[s]=u}else i[s]=r[s];t[n]=i}else t[n]=e[n];return t},undo:function(){},redo:function(){},remove:function(e){var t=this,n={};n.sx=t.objects[e].properties.sx,n.sy=t.objects[e].properties.sy,n.ex=t.objects[e].properties.ex,n.ey=t.objects[e].properties.ey,this.objects[e].remove(),delete this.objects[e],this.draw()},set_properties:function(e,t){e.type=t.type,e.shape_name=t.shape_name,e.data_uuid=t.data_uuid,e.properties.kind=t.properties.kind,e.properties.focus=t.properties.focus,e.properties.is_dragging=t.properties.is_dragging,e.properties.is_drawing_finished=t.properties.is_drawing_finished,e.properties.sx=parseInt(t.properties.sx),e.properties.sy=parseInt(t.properties.sy),e.properties.ex=parseInt(t.properties.ex),e.properties.ey=parseInt(t.properties.ey),e.properties.previous_x=parseInt(t.properties.previous_x),e.properties.previous_y=parseInt(t.properties.previous_y),e.properties.id=t.properties.id,e.properties.name=t.properties.name,e.properties.x=parseInt(t.properties.x),e.properties.y=parseInt(t.properties.y),e.properties.width=parseInt(t.properties.width),e.properties.height=parseInt(t.properties.height),e.properties.connector=t.properties.connector,e.type=="line"&&(e.properties.thickness=t.properties.thickness,e.properties.color=t.properties.color,t.properties.inner_node&&(e.properties.inner_node=t.properties.inner_node))},set_shape_properties:function(target,source){target.type=="square"&&$.each(source.shape.properties,function(key,value){eval("target.shape.properties."+key+" = value;")}),target.shape.set_shape()},set_properties2:function(e,t){var n=this;$(e).each(function(e){n.objects[this].properties.sx=t[this].sx,n.objects[this].properties.sy=t[this].sy,n.objects[this].properties.ex=t[this].ex,n.objects[this].properties.ey=t[this].ey}),this.draw()}};