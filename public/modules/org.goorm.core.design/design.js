/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.design=function(){this.title=null,this.container=null,this.filepath=null,this.filename=null,this.filetype=null,this.ruler=null,this.canvas=null,this.target=null},org.goorm.core.design.prototype={init:function(e,t){var n=this;this.container=e,this.title=t,this.target=e,this.margin_top=200,$(e).append("<div class='canvas_container'></div>"),$(e).find(".canvas_container").css("left",14),$(e).find(".canvas_container").css("top",14),this.ruler=new org.goorm.core.design.ruler,this.ruler.init($(e),"10","px",this.title),this.canvas=new org.goorm.core.design.canvas,this.canvas.init($(e).find(".canvas_container"),800,1e3,this.title,this);var r=new org.goorm.core.menu.context;r.init("","none",$(e).find(".canvas_container"),"")},load:function(filepath,filename,filetype){var self=this,url="file/get_contents",path="workspace/"+filepath+"/"+filename;this.filepath=filepath,this.filename=filename,this.filetype=filetype;var i=0;this.interval=window.setInterval(function(){i<100?statusbar.progressbar.set("value",i+=10):window.clearInterval(self.interval)},100),statusbar.start(),$.ajax({url:url,type:"GET",data:"path="+path,success:function(data){var objects;data&&(filedata=eval("("+data+")"),self.canvas.load(filedata.objects),self.canvas.collaboration.set_filepath()),statusbar.progressbar.set("value",100),self.interval&&window.clearInterval(self.interval),statusbar.stop()}})},save:function(){var e=this,t="file/put_contents",n=this.filepath+"/"+this.filename,r=this.get_source(this.canvas.objects),i='{"filename":"'+this.filename+'",'+'"file_type":'+'"'+this.filetype+'",'+'"project_type":'+'"'+core.status.current_project_type+'",'+'"canvas_width":'+'"'+this.canvas.width+'",'+'"canvas_height":'+'"'+this.canvas.height+'",'+'"last_modified_timestamp":'+'"'+(new Date).getTime()+'",'+'"objects":'+r+"}";$.ajax({url:t,type:"GET",data:{path:n,data:i},success:function(t){m.s("Save complete! ("+e.filename+")","org.goorm.core.design")}})},get_contents:function(){var e=this,t=this.get_source(this.canvas.objects),n='{"filename":"'+this.filename+'",'+'"file_type":'+'"'+this.filetype+'",'+'"project_type":'+'"'+core.status.current_project_type+'",'+'"canvas_width":'+'"'+this.canvas.width+'",'+'"canvas_height":'+'"'+this.canvas.height+'",'+'"last_modified_timestamp":'+'"'+(new Date).getTime()+'",'+'"objects":'+t+"}";return n},resize_all:function(){this.canvas.toolbar.is_ruler_on?($(this.container).find(".canvas_container").width($(this.container).parent().width()-14),$(this.container).find(".canvas_container").height($(this.container).parent().height()-14-36)):($(this.container).find(".canvas_container").width($(this.container).parent().width()),$(this.container).find(".canvas_container").height($(this.container).parent().height()-36)),$(this.container).find(".ruler_x").width($(this.container).find(".canvas_container").width()),$(this.container).find(".ruler_y").height($(this.container).find(".canvas_container").height()-1),this.canvas.height+95>$(this.container).find(".canvas_container").height()?($(this.container).find(".canvas_container").find(".canvas").css("top",50),$(this.container).find(".canvas_container").find(".canvas").css("margin-top",0),$(this.container).find(".ruler_y").css("background-position","0px 50px")):($(this.container).find(".canvas_container").find(".canvas").css("top","50%"),$(this.container).find(".canvas_container").find(".canvas").css("margin-top",0-this.canvas.height/2+10),$(this.container).find(".ruler_y").css("background-position","0px 2"+($(this.container).height()-this.canvas.height)/2+"px")),this.canvas.width+95>$(this.container).find(".canvas_container").width()?($(this.container).find(".canvas_container").find(".canvas").css("left",50),$(this.container).find(".canvas_container").find(".canvas").css("margin-left",0),$(this.container).find(".ruler_x").css("background-position","50px 0px")):($(this.container).find(".canvas_container").find(".canvas").css("left","50%"),$(this.container).find(".canvas_container").find(".canvas").css("margin-left",0-this.canvas.width/2+10),$(this.container).find(".ruler_x").css("background-position",($(this.container).width()-this.canvas.width)/2+2+"px 0px")),this.canvas.skin_width!=null&&(this.canvas.skin_height+95>$(this.container).find(".canvas_container").height()?($(this.container).find(".canvas_container").find(".skin").css("top",50),$(this.container).find(".canvas_container").find(".skin").css("margin-top",0)):($(this.container).find(".canvas_container").find(".skin").css("top","50%"),$(this.container).find(".canvas_container").find(".skin").css("margin-top",0-this.canvas.skin_height/2+10)),this.canvas.skin_width+95>$(this.container).find(".canvas_container").width()?($(this.container).find(".canvas_container").find(".skin").css("left",50),$(this.container).find(".canvas_container").find(".skin").css("margin-left",0),$(this.container).find(".canvas_container").find(".canvas").css("left",($(this.container).find(".canvas_container").find(".space").width()-this.canvas.width)/2+1),$(this.container).find(".canvas_container").find(".canvas").css("margin-left",0)):($(this.container).find(".canvas_container").find(".skin").css("left","50%"),$(this.container).find(".canvas_container").find(".skin").css("margin-left",0-this.canvas.skin_width/2+10),$(this.container).find(".canvas_container").find(".canvas").css("left","50%"),$(this.container).find(".canvas_container").find(".canvas").css("margin-left",0-this.canvas.width/2+7)),$(this.container).find(".canvas_container").find(".canvas").css("margin-top",this.margin_top))},get_source:function(e){var t="[",n=e.length;return $(e).each(function(e){t+="{";var r=0;t+='"type": "'+this.type+'", ',t+='"shape_name": "'+this.shape_name+'", ',t+='"data_uuid": "'+this.data_uuid+'", ',t+='"properties": {',t+='"kind": "'+this.properties.kind+'",',t+='"focus": "'+this.properties.focus+'", ',t+='"is_dragging": "'+this.properties.is_dragging+'", ',t+='"is_drawing_finished": "'+this.properties.is_drawing_finished+'", ',t+='"sx": '+this.properties.sx+", ",t+='"sy": '+this.properties.sy+", ",t+='"ex": '+this.properties.ex+", ",t+='"ey": '+this.properties.ey+", ",t+='"previous_x": '+this.properties.previous_x+", ",t+='"previous_y": '+this.properties.previous_y+", ",t+='"id": "'+this.properties.id+'", ',t+='"name": "'+this.properties.name+'", ',t+='"x": '+this.properties.x+", ",t+='"y": '+this.properties.y+", ",t+='"width": '+this.properties.width+", ",t+='"height": '+this.properties.height+", ";if(this.type=="line"){t+='"thickness": "'+this.properties.thickness+'",',t+='"color": "'+this.properties.color+'",',t+='"inner_node": [';var i=this.properties.inner_node;$(this.properties.inner_node).each(function(e){t+='{"x": '+this.x+', "y": '+this.y+"}",e!=i-1&&(t+=",")}),t+="],"}t+='"connector": "'+this.properties.connector+'"',t+="}";if(this.type=="square"){t+=', "shape": {',t+='"properties": {';var r=0,i=0;$.each(this.shape.properties,function(e,t){i++}),$.each(this.shape.properties,function(e,n){try{t+='"'+e+'": "'+n+'"',r!=i-1&&(t+=","),r++}catch(s){}}),t+="}",t+="}"}t+="}",e!=n-1&&(t+=", ")}),t+="]",t}};