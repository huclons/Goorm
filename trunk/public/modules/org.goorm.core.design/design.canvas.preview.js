/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.design.canvas.preview=function(){this.panel=null,this.target=null,this.real_target=null,this.real_width=null,this.real_height=null,this.width=null,this.height=null,this.left=null,this.top=null,this.scale=null,this.parent=null,this.indicator_width=null,this.is_preview_clicked=null,this.indicator_top_fake=null},org.goorm.core.design.canvas.preview.prototype={init:function(e,t,n,r,i){var s=this;s.target=e,s.real_width=t,s.width=t*r,s.real_height=n,s.height=n*r,s.scale=r,s.parent=i,s.is_preview_clicked=!1,s.indicator_top_fake=30,this.panel=new YAHOO.widget.Panel(e,{visible:!0,underlay:"none",close:!1,autofillheight:"body",draggable:!0,constraintoviewport:!0}),this.panel.setHeader("<div style='overflow:auto' class='titlebar'><div style='float:left; font-size:9px;'>Preview</div><div style='float:right;'><img src='images/icons/context/closebutton.png' class='closePreview window_button' /></div></div>"),this.panel.setBody("<div class='window_container'></div>"),this.panel.render(),$(e).parent().css("left",30),$(e).parent().css("top",70),$(e).find(".hd").mouseup(function(){s.left=parseInt($(s.target).parent().offset().left-$(s.target).parent().parent().offset().left),s.top=parseInt($(s.target).parent().offset().top-$(s.target).parent().parent().offset().top)}),$(e).find(".window_container").append("<div class='previewCanvasIndicator'></div>"),$(e).find(".window_container").append("<div class='previewCanvas'></div>"),$(e).find(".window_container").find(".previewCanvas").append("<canvas width='"+s.width+"' height='"+s.height+"'></canvas>"),$(e).find(".window_container").find(".previewCanvas").append("<div class='previewEvent' style='width:"+s.width+"px; height:"+s.height+"px;'></div>"),$(s.target).find(".closePreview").click(function(){s.parent.toolbar.toggle_preview()})},setSize:function(e,t){var n=this;e=="change"&&(n.real_width=n.parent.width,n.width=n.parent.width*n.scale,n.real_height=n.parent.height,n.height=n.parent.height*n.scale,t?n.indicator_top_fake=t:n.indicator_top_fake=30,$(n.target).find(".window_container").find(".previewCanvas").find("canvas").attr("width",n.width),$(n.target).find(".window_container").find(".previewCanvas").find("canvas").attr("height",n.height),$(n.target).find(".window_container").find(".previewCanvas").find(".previewEvent").width(n.width),$(n.target).find(".window_container").find(".previewCanvas").find(".previewEvent").height(n.height)),$(n.target).find(".window_container").width(n.width),$(n.target).find(".window_container").height(n.height),$(n.target).parent().parent().find(".canvas_container").width()-14>n.real_width?n.indicator_width=$(n.target).find(".window_container").width()+3:n.indicator_width=($(n.target).parent().parent().find(".canvas_container").width()-14)*n.scale,n.indicatorHeight=($(n.target).parent().parent().find(".canvas_container").height()-14)*n.scale,$(n.target).find(".previewCanvasIndicator").width(n.indicator_width-5),$(n.target).find(".previewCanvasIndicator").height(n.indicatorHeight-5)},setup:function(){var e=this;e.left=parseInt($(e.target).parent().css("left")),e.top=parseInt($(e.target).parent().css("top")),e.indicator_top_fake=30,$(e.parent.target).scroll(function(){var t=$(this).scrollLeft(),n=$(this).scrollTop(),r=e.real_height*e.scale-$(e.target).find(".previewCanvasIndicator").height();(t-45)*e.scale<=0?$(e.target).find(".previewCanvasIndicator").css("left",0):(t-45)*e.scale>e.width-e.indicator_width+3?($(e.target).find(".previewCanvasIndicator").css("left",""),$(e.target).find(".previewCanvasIndicator").css("right",0)):$(e.target).find(".previewCanvasIndicator").css("left",(t-45)*e.scale),(n-e.indicator_top_fake)*e.scale<=0?$(e.target).find(".previewCanvasIndicator").css("top",0):(n-e.indicator_top_fake)*e.scale>e.height-e.indicatorHeight+3?($(e.target).find(".previewCanvasIndicator").css("top",""),$(e.target).find(".previewCanvasIndicator").css("bottom",0)):$(e.target).find(".previewCanvasIndicator").css("top",(n-e.indicator_top_fake)*e.scale)}),$(e.target).find(".previewEvent").mousedown(function(t){e.is_preview_clicked=!0}),$(e.target).find(".previewEvent").mouseup(function(t){e.is_preview_clicked=!1;var n=t.pageX-$(this).offset().left,r=t.pageY-$(this).offset().top;e.moveScrollFromEvent(n,r)}),$(e.target).find(".previewEvent").mousemove(function(t){if(e.is_preview_clicked){var n=t.pageX-$(this).offset().left,r=t.pageY-$(this).offset().top;e.moveScrollFromEvent(n,r)}}),$(e.target).find(".previewEvent").mouseout(function(t){e.is_preview_clicked=!1})},moveScrollFromEvent:function(e,t){var n=this;if(t<n.indicatorHeight/2)$(n.target).parent().parent().find(".canvas_container").scrollTop(n.indicator_top_fake);else if(t>n.height-n.indicatorHeight/2){var r=$(n.target).parent().parent().find(".canvas_container").find(".space").height(),i=$(n.target).parent().parent().find(".canvas_container").height()-14;$(n.target).parent().parent().find(".canvas_container").scrollTop(r-i-n.indicator_top_fake)}else $(n.target).parent().parent().find(".canvas_container").scrollTop((t-n.indicatorHeight/2)/n.scale+n.indicator_top_fake);if(n.width-2>$(n.target).find(".previewCanvasIndicator").width())if(e<n.indicator_width/2)$(n.target).parent().parent().find(".canvas_container").scrollLeft(18);else if(e>n.width-n.indicator_width/2+5){var s=$(n.target).parent().parent().find(".canvas_container").find(".space").width(),o=$(n.target).parent().parent().find(".canvas_container").width()-14;$(n.target).parent().parent().find(".canvas_container").scrollLeft(s-o-18+14)}else $(n.target).parent().parent().find(".canvas_container").scrollLeft((e-n.indicator_width/2+4)/n.scale);else{var s=$(n.target).parent().parent().find(".canvas_container").find(".space").width(),o=$(n.target).parent().parent().find(".canvas_container").width()-14;$(n.target).parent().parent().find(".canvas_container").scrollLeft((s-o)/2)}},draw:function(){var e=this;if($(this.target).find(".previewCanvas").find("canvas")[0].getContext){var t=$(this.target).find(".previewCanvas").find("canvas")[0].getContext("2d");t.clearRect(0,0,$(this.target).find(".previewCanvas").find("canvas").width(),$(this.target).find(".previewCanvas").find("canvas").height()),$(this.parent.objects).each(function(n){if($(this)[0].type=="line"){var r=0,i=0,s=0,o=0;$(this)[0].properties.sx&&(r=parseInt($(this)[0].properties.sx),r*=e.scale),$(this)[0].properties.sy&&(i=parseInt($(this)[0].properties.sy),i*=e.scale),$(this)[0].properties.ex&&(s=parseInt($(this)[0].properties.ex),s*=e.scale),$(this)[0].properties.ey&&(o=parseInt($(this)[0].properties.ey),o*=e.scale),e.parent.hovered_index==n&&(t.beginPath(),t.strokeStyle="#FFFF00",t.moveTo(r,i),t.lineTo(s,o),t.lineWidth=parseFloat($(this)[0].properties.thickness)*e.scale+5,t.stroke()),t.beginPath(),t.strokeStyle="#000000";if(this.properties.dashed){var u=[5,4],a=u.length,f,l,c=0,h=!0,p,d;s<r?(p=s,d=o):(p=r,d=i),f=s-r,l=o-i,t.moveTo(p,d),t.lineWidth=parseFloat($(this)[0].properties.thickness);var v=l/f,m=Math.sqrt(f*f+l*l);while(m>=.1){var g=u[c++%a];g>m&&(g=m);var y=Math.sqrt(g*g/(1+v*v));p+=y,d+=v*y,t[h?"lineTo":"moveTo"](p,d),m-=g,h=!h}t.stroke()}else t.moveTo(r,i),t.lineTo(s,o),t.lineWidth=parseFloat($(this)[0].properties.thickness)*e.scale+.5,t.stroke();this.shape&&this.shape.rotate&&this.shape.rotate(this.properties.sx,this.properties.sy,this.properties.ex,this.properties.ey)}else if($(this)[0].type=="square"){var r=0,i=0,s=0,o=0;$(this)[0].properties.sx&&(r=parseInt($(this)[0].properties.sx),r*=e.scale),$(this)[0].properties.sy&&(i=parseInt($(this)[0].properties.sy),i*=e.scale),$(this)[0].properties.ex&&(s=parseInt($(this)[0].properties.ex),s*=e.scale),$(this)[0].properties.ey&&(o=parseInt($(this)[0].properties.ey),o*=e.scale),e.parent.hovered_index==n&&(t.beginPath(),t.strokeStyle="#FFFF00",t.rect(r,i,s-r,o-i),t.lineWidth=5,t.closePath(),t.stroke(),t.beginPath(),t.strokeStyle="#000000",t.fillStyle="#FFFFFF",t.rect(r,i,s-r,o-i),t.lineWidth=.5,t.closePath(),t.stroke()),t.beginPath(),t.strokeStyle="#000000",t.fillStyle="#FFFFFF",t.rect(r,i,s-r,o-i),t.lineWidth=.5,t.closePath(),t.stroke(),t.fill(),this.shape&&this.shape.move&&(this.shape.move(this.properties.sx,this.properties.sy,this.properties.ex,this.properties.ey),this.shape.set_shape())}})}}};