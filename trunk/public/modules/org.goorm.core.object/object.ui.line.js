/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.object.ui.line=function(){this.target=null,this.timestamp=null,this.focus=!0,this.is_dragging=!1,this.is_drawing_finished=!1,this.selected_node=null,this.inner_node=null,this.selected_inner_node_index=null,this.sx=null,this.sy=null,this.ex=null,this.ey=null,this.previous_x=null,this.previous_y=null,this.id=null,this.name=null,this.type=null,this.x=null,this.y=null,this.width=null,this.height=null,this.thickness=.5,this.color="#000",this.connector=null,this.status=null,this.head_type=null,this.tail_type=null,this.dashed=!1,this.attribute_list=new Array("id","name","kind","timestamp","sx","sy","ex","ey","thickness","color")},org.goorm.core.object.ui.line.prototype={init:function(e,t,n){var r=this;return this.target=e,this.dashed=n,this.timestamp=(new Date).getTime(),this.connector=[],this.connector.head=null,this.connector.tail=null,this.id="line_"+this.timestamp,this.name="line_"+this.timestamp,this.kind=t,this.x=0,this.y=0,this.width=0,this.height=0,this.inner_node=[],$(e).find("canvas").mousedown(function(e){if(!r.focus)return!1;var t=$(this).parent().offset();x=e.pageX-t.left,y=e.pageY-t.top,r.sx&&(r.sx=parseInt(r.sx)),r.sy&&(r.sy=parseInt(r.sy)),r.ex&&(r.ex=parseInt(r.ex)),r.ey&&(r.ey=parseInt(r.ey)),e.which==1&&(r.is_hovered(x,y)>=0&&(r.is_dragging=!0,r.is_drawing_finished=!1,r.selected_node="body",x=e.pageX-t.left,y=e.pageY-t.top,r.previous_x=x,r.previous_y=y),!r.is_drawing_finished&&!r.is_dragging?(r.is_dragging=!0,r.is_drawing_finished=!1,x=e.pageX-t.left,y=e.pageY-t.top,r.sx=x,r.sy=y,r.selected_node=null):(x=e.pageX-t.left,y=e.pageY-t.top,r.sy-3<y&&y<r.sy+3&&r.sx-3<x&&x<r.sx+3?(r.is_dragging=!0,r.is_drawing_finished=!1,r.selected_node="head"):r.ey-3<y&&y<r.ey+3&&r.ex-3<x&&x<r.ex+3?(r.is_dragging=!0,r.is_drawing_finished=!1,r.selected_node="tail"):$(r.inner_node).each(function(e){if(this.y-3<y&&y<this.y+3&&this.x-3<x&&x<this.x+3)return r.is_dragging=!0,r.is_drawing_finished=!1,r.selected_node="inner_node",r.selected_inner_node_index=e,!1})))}),$(e).find("canvas").mousemove(function(e){if(!r.focus)return!1;var t=$(this).parent().offset();x=Math.floor(e.pageX-t.left),y=Math.floor(e.pageY-t.top),!r.is_drawing_finished&&r.is_dragging&&(r.selected_node=="head"?(r.sx=x,r.sy=y):r.selected_node=="body"?(r.sx+=x-r.previous_x,r.sy+=y-r.previous_y,r.ex+=x-r.previous_x,r.ey+=y-r.previous_y,$(r.inner_node).each(function(e){this.x+=x-r.previous_x,this.y+=y-r.previous_y}),r.previous_x=x,r.previous_y=y):r.selected_node=="inner_node"?(r.inner_node[r.selected_inner_node_index].x=x,r.inner_node[r.selected_inner_node_index].y=y):(r.ex=x,r.ey=y),r.draw_line(r.sx,r.sy,r.ex,r.ey)),r.sy-3<y&&y<r.sy+3&&r.sx-3<x&&x<r.sx+3||r.ey-3<y&&y<r.ey+3&&r.ex-3<x&&x<r.ex+3?r.change_status("status_drawing_line"):$(r.inner_node).each(function(e){this.y-3<y&&y<this.y+3&&this.x-3<x&&x<this.x+3&&r.change_status("status_drawing_line")})}),$(e).find("canvas").mouseup(function(e){if(!r.focus)return!1;if(e.which==1)!r.is_drawing_finished&&r.is_dragging&&(r.is_dragging=!1,r.is_drawing_finished=!0,r.sx&&(r.sx=parseInt(r.sx)),r.sy&&(r.sy=parseInt(r.sy)),r.ex&&(r.ex=parseInt(r.ex)),r.ey&&(r.ey=parseInt(r.ey)),r.x=r.sx,r.y=r.sy,r.width=Math.abs(r.ex-r.sx),r.height=Math.abs(r.ey-r.sy),r.status="modified"),r.change_status("status_default");else if(e.which==3)return e.preventDefault(),e.stopPropagation(),!1;r.clear()}),$(e).find("canvas").click(function(e){if(!r.focus)return!1;if(e.which==3)return e.preventDefault(),e.stopPropagation(),!1}),$(e).find("canvas").dblclick(function(e){if(!r.focus)return!1;var t=$(this).parent().offset();x=e.pageX-t.left,y=e.pageY-t.top,r.sx&&(r.sx=parseInt(r.sx)),r.sy&&(r.sy=parseInt(r.sy)),r.ex&&(r.ex=parseInt(r.ex)),r.ey&&(r.ey=parseInt(r.ey));if(e.which==1){var n=r.is_hovered(x,y);if(n>=0){var i=!1;$(r.inner_node).each(function(e){if(this.y-3<y&&y<this.y+3&&this.x-3<x&&x<this.x+3)return r.pop_inner_node(e),i=!0,!1}),i||r.push_inner_node(x,y,n)}}}),this},push_inner_node:function(e,t,n){var r=this;r.inner_node.length>1?r.inner_node.splice(n,0,{x:e,y:t}):r.inner_node.push({x:e,y:t})},pop_inner_node:function(e){var t=this;t.inner_node.length>1?t.inner_node.splice(e,1):t.inner_node.pop()},is_hovered:function(e,t){var n,r,i,s;for(var o=0;o<=this.inner_node.length;o++){o==0?this.inner_node.length==0?(n=this.sx,r=this.sy,i=this.ex,s=this.ey):(n=this.sx,r=this.sy,i=this.inner_node[0].x,s=this.inner_node[0].y):o==this.inner_node.length?(n=this.inner_node[o-1].x,r=this.inner_node[o-1].y,i=this.ex,s=this.ey):(n=this.inner_node[o-1].x,r=this.inner_node[o-1].y,i=this.inner_node[o].x,s=this.inner_node[o].y);if((n-5<e&&e<i+5||i-5<e&&e<n+5)&&(r-5<t&&t<s+5||s-5<t&&t<r+5)){var u,a,f,l=5;if(i-n!=0){u=(s-r)/(i-n),l=Math.round(5*Math.sqrt(u*u+1)*1e3)/1e3,a=r-u*n-l,f=r-u*n+l;if(Math.round(Math.abs(u)*1e3)/1e3<.01||Math.round(Math.abs(1/u)*1e3)/1e3<.01||u*e+a<=t&&t<=u*e+f&&((t-a)/u<=e&&e<=(t-f)/u||(t-f)/u<=e&&e<=(t-a)/u))return o}}}return-1},draw_line:function(e,t,n,r){e&&(e=parseInt(e)),t&&(t=parseInt(t)),n&&(n=parseInt(n)),r&&(r=parseInt(r));if($(this.target).find("canvas").getContext){var i=$(this.target).find("canvas").getContext("2d");i.clearRect(0,0,$(this.target).find("canvas").width(),$(this.target).find("canvas").height()),this.is_dragging&&(i.beginPath(),i.strokeStyle="#ccc",i.moveTo(e,t),$(this.properties.inner_node).each(function(){i.lineTo(this.x,this.y)}),i.lineTo(n,r),i.lineWidth=.5,i.stroke())}},clear:function(){if($(this.target).find("canvas").getContext){var e=$(this.target).find("canvas").getContext("2d");e.clearRect(0,0,$(this.target).find("canvas").width(),$(this.target).find("canvas").height())}},remove:function(){this.target=null,this.timestamp=null,this.focus=null,this.is_dragging=null,this.is_drawing_finished=null,this.selected_node=null,this.sx=null,this.sy=null,this.ex=null,this.ey=null,this.inner_node=null,this.previous_x=null,this.previous_y=null,this.id=null,this.name=null,this.x=null,this.y=null,this.width=null,this.height=null,this.thickness=null,this.connector=null,delete this},change_status:function(e){$(this.target).removeClass("status_default"),$(this.target).removeClass("status_drawing_line"),$(this.target).removeClass("status_drawing_square"),$(this.target).removeClass("status_move"),$(this.target).removeClass("status_resize_top_left"),$(this.target).removeClass("status_resize_top_right"),$(this.target).removeClass("status_resize_bottom_left"),$(this.target).removeClass("status_resize_bottom_right"),$(this.target).removeClass("status_resize_top"),$(this.target).removeClass("status_resize_bottom"),$(this.target).removeClass("status_resize_left"),$(this.target).removeClass("status_resize_right"),$(this.target).addClass(e)},move:function(e,t){this.sx+=e,this.sy+=t,this.ex+=e,this.ey+=t,$(this.inner_node).each(function(n){this.x+=e,this.y+=t}),this.status="modified"}};