/**
 * Copyright Sung-tae Ryu. All rights reserved.
 * Code licensed under the GPL v2 License:
 * http://www.goorm.org/License
 **/org.goorm.core.collaboration.editing=function(){this.target=null,this.diff_worker=null,this.patch_worker=null,this.socket=null,this.previous_text=null,this.task_queue=[],this.removed_lines_uuids=[],this.user=null,this.updating_process_running=!1,this.playback_mode=!1,this.take_diffs=!0,this.stored_lines={},this.contents=null,this.editor=null,this.parent=null,this.filename=null,this.filepath=null,this.identifier=null,this.auto_save_timer=null,this.status=0,this.timer=null},org.goorm.core.collaboration.editing.prototype={init:function(e){var t=this;this.parent=e,this.target=e.target,this.socket=io.connect(),this.task_queue=[],this.removed_lines_uuids=[],this.user=core.user.first_name+"_"+core.user.last_name;var n=function(){while(t.task_queue.length>0&&t.updating_process_running==0){var e=t.task_queue.shift();t.updating_process_running=!0,t.apply_update(e.action,e.message)}};this.timer=window.setInterval(n,500),this.set_collaboration_data("!refresh"),this.socket.on("editing_message",function(e){if(!e)return!1;var n=JSON.parse(e);if(n.channel=="editing"&&n.user!=core.user.first_name+"_"+core.user.last_name&&n.filepath==t.filepath)switch(n.action){case"change":t.task_queue.push(n);break;case"cursor":t.task_queue.push(n);break;default:}}),this.socket.on("editing_someone_leaved",function(e){console.log(e+" leaved..."),$(t.target).find(".CodeMirror-scroll").find(".user_name_"+e).remove(),$(t.target).find(".CodeMirror-scroll").find(".user_cursor_"+e).remove()}),$(this.target).find("[id='collaboration.editing']").keydown(function(e){if(e.keyCode==8||e.keyCode==46){var n=$(t.target).find("[id='collaboration.editing']").find("div").find("p");if(n.length==1&&$(n[0]).html()=="")return $(n[0]).html("&nbsp;"),!1}}),setInterval(function(){$(t.target).find(".CodeMirror-scroll").find(".user_cursor").each(function(e){$(this).css("visibility")=="hidden"?$(this).css("visibility","visible"):$(this).css("visibility","hidden")})},600)},set_editor:function(e){this.editor=e},set_filepath:function(){this.filepath=this.parent.filepath+this.parent.filename},update_change:function(e){var t=this;if(this.socket!=null){if(!t.socket.socket.connected)return alert.show("Collaboration server is disconnected!"),!1;e.user=core.user.first_name+"_"+core.user.last_name,t.socket.emit("message",'{"channel": "editing", "action":"change", "user":"'+core.user.first_name+"_"+core.user.last_name+'", "workspace": "'+core.status.current_project_name+'", "filepath":"'+t.filepath+'", "message":'+JSON.stringify(e)+"}"),clearTimeout(this.auto_save_timer),this.auto_save_timer=setTimeout(function(){t.parent.save()},5e3)}},update_cursor:function(e){var t=this;if(this.socket!=null){if(!t.socket.socket.connected)return alert.show("Collaboration server is disconnected!"),!1;e.user=core.user.first_name+"_"+core.user.last_name,t.socket.emit("message",'{"channel": "editing", "action":"cursor", "user":"'+core.user.first_name+"_"+core.user.last_name+'", "workspace": "'+core.status.current_project_name+'", "filepath":"'+t.filepath+'", "message":'+JSON.stringify(e)+"}")}},apply_update:function(e,t){switch(e){case"change":this.change(t);break;case"cursor":this.set_cursor(t);break;default:console.log("invalid update")}},set_cursor:function(e){if(e.user!=core.user.first_name+"_"+core.user.last_name){var t=this.editor.charCoords({line:e.line,ch:e.ch}),n=parseInt(t.y)-parseInt($(this.target).find(".CodeMirror-scroll").offset().top),r=parseInt(t.x)-parseInt($(this.target).find(".CodeMirror-scroll").offset().left);if($(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).length>0)$(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).css("top",n-8),$(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).css("left",r+5),$(this.target).find(".CodeMirror-scroll").find(".user_cursor_"+e.user).css("top",n),$(this.target).find(".CodeMirror-scroll").find(".user_cursor_"+e.user).css("left",r);else{$(this.target).find(".CodeMirror-scroll").prepend("<span class='user_name_"+e.user+" user_name' style='top:"+(n-8)+"px; left:"+(r+5)+"px;'>"+e.user+"</span>"),$(this.target).find(".CodeMirror-scroll").prepend("<span class='user_cursor_"+e.user+" user_cursor' style='top:"+n+"px; left:"+r+"px;'></span>");var i=Math.floor(Math.random()*206)-Math.floor(Math.random()*30),s=Math.floor(Math.random()*206)-Math.floor(Math.random()*30),o=Math.floor(Math.random()*206)-Math.floor(Math.random()*30),u=i+90>=255?255:i+90,a=i+90>=255?255:s+90,f=i+90>=255?255:o+90,l="#"+i.toString(16)+s.toString(16)+o.toString(16),c="#"+u.toString(16)+a.toString(16)+f.toString(16);$(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).css("background-color",c),$(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).css("border-color",l),$(this.target).find(".CodeMirror-scroll").find(".user_name_"+e.user).css("color",l),$(this.target).find(".CodeMirror-scroll").find(".user_cursor_"+e.user).css("border-color",l)}}this.updating_process_running=!1},change:function(e){var t=this;if(e.user!=core.user.first_name+"_"+core.user.last_name){var n="";for(var r=0;r<e.text.length;r++)r!=0&&(n+="\n"),n+=e.text[r];this.editor.replaceRange(n,e.from,e.to)}this.updating_process_running=!1},generate_uuid:function(){var e="1",t=this.user,n=new Date,r=$.map([n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),n.getUTCMilliseconds()],function(e,t){return e<10?"0"+e:e}).join("");return e+"_"+t+"_"+r},set_collaboration_data:function(e){var t=this;if(e){if(e=="!refresh")return this.set_collaboration_data(this.contents),!1;var n=e.split("\n"),r="";$(n).each(function(e){r+="<p id='line"+(e+1)+"' data-uuid='"+t.generate_uuid()+"'>"+this+"</p>"}),$(this.target).find("[id='collaboration.editing']").find("div").html(r),this.contents=e}else $(this.target).find("[id='collaboration.editing']").find("div").html("<p id='line1' data-uuid='"+this.generate_uuid()+"'>&nbsp;</p>")}};